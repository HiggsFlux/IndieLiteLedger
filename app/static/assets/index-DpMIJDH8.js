import{a5 as me,d as _e,a6 as pe,a7 as fe,a8 as ye,r as v,M as ge,a9 as E,a as K,aa as U,N as xe,b as g,o as c,f as l,w as a,O as ve,e as d,g as u,ab as be,ac as De,t as f,c as V,y as we,ad as Ee,ae as Ve,p as Te,q as Me,Y as Ye,Z as ke,W as he,X as Re,af as Ae,E as Le,a0 as Ue,ag as Ie,ah as Ce,G as b,ai as H,aj as W,ak as X,v as Se,R as Ne,al as qe,U as je,J as ze,a2 as x,a4 as Oe}from"./index-xTveqTne.js";import{f as Pe}from"./license-config-tLAC3KGb.js";import{d as Be}from"./license-record-BAeqi8K7.js";import{f as Fe}from"./client-2bbT_4mG.js";function $e(I){return me({url:"/plugins/commercial/license/generate",method:"post",data:I})}const Ge={class:"h-full overflow-hidden flex flex-col"},Je={class:"flex justify-between items-center"},Ke={key:0,class:"flex gap-2"},He={key:0,class:"flex flex-col items-center justify-center py-10 space-y-6"},We={class:"w-200 bg-gray-50 p-4 rounded border border-gray-200"},Xe={class:"text-xs overflow-auto max-h-60"},Ze={class:"w-full"},Qe={class:"flex gap-2 w-full"},et={class:"mt-auto pt-6 border-t border-gray-100"},tt={class:"mb-2 text-base font-medium text-gray-700 flex justify-between items-center"},lt={class:"text-xs text-gray-400 font-normal"},at={class:"space-y-4 pt-2"},ot={class:"flex items-center justify-between mb-3"},st={class:"font-medium text-gray-800"},nt={class:"ml-2 text-xs text-gray-400 font-mono"},dt={key:0,class:"pl-7 animate-fade-in animate-duration-200"},rt={class:"flex items-center gap-6"},ut={class:"space-y-4 pt-2"},it={class:"flex items-center justify-between mb-3"},ct={class:"font-medium text-gray-800"},mt={class:"ml-2 text-xs text-gray-400 font-mono"},_t={key:0,class:"pl-7 animate-fade-in animate-duration-200"},pt={class:"flex items-center gap-6"},Q=_e({name:"commercial_generate",__name:"index",setup(I){const C=pe(),M=fe(),ee=ye(),w=v(!1),Y=v(!1),S=v("system"),N=v(!1);v(!1);const k=v(null),o=ge({customer_name:"",edition:"功能定制版",license_type:"TRIAL",expire_at:E().add(31,"day").format("YYYY-MM-DD"),machine_id:"",max_users:2,max_connections:1}),te={customer_name:[{required:!0,message:"请选择客户",trigger:"change"}],edition:[{required:!0,message:"请选择版本",trigger:"change"}],license_type:[{required:!0,message:"请选择授权类型",trigger:"change"}],expire_at:[{required:!0,message:"请选择过期日期",trigger:"change"}],machine_id:[{required:!0,message:"请输入机器码",trigger:"blur"}],max_users:[{required:!0,message:"请输入最大用户数",trigger:"blur"}],max_connections:[{required:!0,message:"请输入最大连接数",trigger:"blur"}]},h=s=>{if(o.license_type==="TRIAL"){const e=new Date;return e.setDate(e.getDate()+90),s.getTime()>e.getTime()||s.getTime()<Date.now()-864e5}return s.getTime()<Date.now()-864e5},y=v([]),q=K(()=>y.value.filter(s=>s.module_type==="SYSTEM")),j=K(()=>y.value.filter(s=>s.module_type!=="SYSTEM")),m=v(null),z=()=>{const s=o.edition==="企业版";y.value.forEach(e=>{if(e.module_code==="sys_core"){e.selected=!0;return}s?e.selected=!0:e.selected=!1})};U(()=>o.edition,()=>{z()}),U(()=>o.license_type,s=>{if(s==="TRIAL"){const e=new Date;e.setDate(e.getDate()+90);const n=e.toISOString().split("T")[0];new Date(o.expire_at).getTime()>e.getTime()&&(o.expire_at=n),y.value.forEach(r=>{r.module_code!=="sys_core"&&(r.expire_type="DATE",(!r.custom_date||new Date(r.custom_date).getTime()>e.getTime())&&(r.custom_date=n))})}}),U(()=>o.expire_at,s=>{const e=y.value.find(n=>n.module_code==="sys_core");e&&(e.custom_date=s)});async function le(){if(m.value)try{const s=await Be(m.value.id),e=new Blob([s.data],{type:"application/octet-stream"}),n=window.URL.createObjectURL(e),r=document.createElement("a");r.href=n;const _=`${m.value.license_key}.key`;r.setAttribute("download",_),document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(n)}catch(s){console.error(s),x.error("下载失败")}}async function ae(){const s=C.query.client_id;if(!s){x.error("请从客户详情页进入授权生成页面"),M.push("/customer/list");return}N.value=!0;try{const{data:e,error:n}=await Fe(s);if(n){x.error("客户不存在或已被删除，请重新选择"),M.push("/customer/list");return}e&&(o.customer_name=e.name,e.type===1?o.edition="企业版":o.edition="功能定制版",ee.setTabLabel(`授权生成 - ${e.name}`))}catch(e){console.error(e),x.error("获取客户信息失败，请重新选择"),M.push("/customer/list")}finally{N.value=!1}}async function O(){w.value=!0;try{const{data:s}=await Pe({is_active:!0});if(s){y.value=s.map(n=>({...n,selected:!1,expire_type:"DATE",custom_date:E().add(31,"day").format("YYYY-MM-DD")}));const e={id:"core-hardcoded-id",module_code:"sys_core",module_name:"TalkMyData Core",module_name_cn:"TalkMyData 核心系统",module_type:"SYSTEM",description:"TalkMyData Core System",sort_order:1,is_active:!0,created_at:"",updated_at:"",selected:!0,expire_type:"DATE",custom_date:o.expire_at};y.value.unshift(e),z()}}finally{w.value=!1}}async function oe(){await k.value?.validate();const s=y.value.filter(n=>n.selected);if(s.length===0){x.warning("请至少选择一个授权模块");return}if(o.license_type==="TRIAL"){const n=E().add(90,"day").endOf("day").toDate();if(E(o.expire_at).isAfter(n)){x.warning("试用版基础过期日期不能超过90天");return}const r=s.filter(_=>_.module_code==="sys_core"?!1:_.expire_type==="PERMANENT"||!_.custom_date?!0:E(_.custom_date).isAfter(n));if(r.length>0){x.warning(`试用版模块 "${r[0].module_name}" 必须指定日期且不能超过90天`);return}}const e=s.filter(n=>n.expire_type==="DATE"&&!n.custom_date);if(e.length>0){x.warning(`请为模块 "${e[0].module_name}" 选择过期日期`);return}Y.value=!0;try{const n=s.map(i=>({code:i.module_code,name:i.module_name,name_cn:i.module_name_cn,type:i.module_type,expire_at:i.expire_type==="PERMANENT"?"PERMANENT":i.custom_date})),r={...o,client_id:C.query.client_id,modules:n},{data:_,error:T}=await $e(r);!T&&_&&(x.success("授权生成成功"),m.value=_)}finally{Y.value=!1}}function se(){k.value?.resetFields(),O(),m.value=null}return xe(()=>{O(),ae()}),(s,e)=>{const n=Le,r=De,_=be,T=Me,i=Te,D=ke,R=Ye,A=Re,ne=he,L=Ae,P=Ue,B=Ve,F=Se,$=Ne,G=qe,J=Ce,de=Ie,re=Ee,ue=we,ie=ze,ce=je;return c(),g("div",Ge,[l(ie,{shadow:"never",class:"flex-1 overflow-auto"},{header:a(()=>[d("div",Je,[e[12]||(e[12]=d("span",{class:"text-lg font-bold"},"授权生成 (License Generation)",-1)),m.value?(c(),g("div",Ke,[l(n,{plain:"",onClick:e[0]||(e[0]=t=>m.value=null)},{default:a(()=>[...e[10]||(e[10]=[u(" 继续生成 ",-1)])]),_:1}),l(n,{type:"primary",onClick:le},{default:a(()=>[...e[11]||(e[11]=[u(" 下载授权文件 ",-1)])]),_:1})])):b("",!0)])]),default:a(()=>[m.value?(c(),g("div",He,[e[14]||(e[14]=d("div",{class:"text-xl text-success font-bold flex items-center gap-2"},[d("div",{class:"i-ep-circle-check-filled text-4xl"}),u(" 生成成功 ")],-1)),l(_,{border:"",column:1,class:"w-200",title:"授权详情"},{default:a(()=>[l(r,{label:"License ID"},{default:a(()=>[u(f(m.value.id),1)]),_:1}),l(r,{label:"License Key"},{default:a(()=>[u(f(m.value.license_key),1)]),_:1}),l(r,{label:"文件路径"},{default:a(()=>[u(f(m.value.file_path),1)]),_:1})]),_:1}),d("div",We,[e[13]||(e[13]=d("div",{class:"text-sm text-gray-500 mb-2"},"Payload 快照:",-1)),d("pre",Xe,f(JSON.stringify(m.value.payload,null,2)),1)])])):ve((c(),V(ue,{key:1,ref_key:"formRef",ref:k,model:o,rules:te,"label-position":"top",class:"h-full"},{default:a(()=>[l(re,{gutter:24,class:"h-full"},{default:a(()=>[l(B,{span:8,class:"border-r border-gray-100 pr-6 h-full flex flex-col"},{default:a(()=>[e[21]||(e[21]=d("h3",{class:"mb-4 text-base font-medium text-gray-700"},"基础信息 (Basic Info)",-1)),l(i,{label:"授权给 (Issued To)",prop:"customer_name"},{default:a(()=>[d("div",Ze,[l(T,{modelValue:o.customer_name,"onUpdate:modelValue":e[1]||(e[1]=t=>o.customer_name=t),disabled:"",placeholder:"Client Name"},{prefix:a(()=>[...e[15]||(e[15]=[d("div",{class:"i-ep-user"},null,-1)])]),_:1},8,["modelValue"])])]),_:1}),l(i,{label:"授权类型 (License Type)",prop:"license_type"},{default:a(()=>[l(R,{modelValue:o.license_type,"onUpdate:modelValue":e[2]||(e[2]=t=>o.license_type=t),class:"w-full"},{default:a(()=>[l(D,{value:"OFFICIAL",border:"",class:"mr-4!"},{default:a(()=>[...e[16]||(e[16]=[u("正式版",-1)])]),_:1}),l(D,{value:"TRIAL",border:""},{default:a(()=>[...e[17]||(e[17]=[u("试用版",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"版本 (Edition)",prop:"edition"},{default:a(()=>[l(ne,{modelValue:o.edition,"onUpdate:modelValue":e[3]||(e[3]=t=>o.edition=t),placeholder:"请选择版本",class:"w-full"},{default:a(()=>[l(A,{label:"功能定制版",value:"功能定制版"}),l(A,{label:"高级版",value:"高级版"}),l(A,{label:"企业版",value:"企业版"})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"过期日期 (Expire At)",prop:"expire_at"},{default:a(()=>[d("div",Qe,[l(L,{modelValue:o.expire_at,"onUpdate:modelValue":e[4]||(e[4]=t=>o.expire_at=t),type:"date",placeholder:"选择过期日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"flex-1","disabled-date":h},null,8,["modelValue"]),l(n,{type:"primary",plain:"",disabled:o.license_type==="TRIAL",onClick:e[5]||(e[5]=t=>o.expire_at="2099-12-31")},{default:a(()=>[...e[18]||(e[18]=[u(" 永久 ",-1)])]),_:1},8,["disabled"])])]),_:1}),l(i,{label:"机器码 (Machine ID)",prop:"machine_id"},{default:a(()=>[l(T,{modelValue:o.machine_id,"onUpdate:modelValue":e[6]||(e[6]=t=>o.machine_id=t),placeholder:"输入 Hardware ID 绑定特定机器"},null,8,["modelValue"])]),_:1}),l(i,{label:"最大用户数 (Max Users)",prop:"max_users"},{default:a(()=>[l(P,{modelValue:o.max_users,"onUpdate:modelValue":e[7]||(e[7]=t=>o.max_users=t),min:1,class:"w-full"},null,8,["modelValue"])]),_:1}),l(i,{label:"最大连接数 (Max Connections)",prop:"max_connections"},{default:a(()=>[l(P,{modelValue:o.max_connections,"onUpdate:modelValue":e[8]||(e[8]=t=>o.max_connections=t),min:1,class:"w-full"},null,8,["modelValue"])]),_:1}),d("div",et,[l(n,{type:"primary",class:"w-full mb-3",size:"large",loading:Y.value,onClick:oe},{default:a(()=>[...e[19]||(e[19]=[u(" 生成授权文件 ",-1)])]),_:1},8,["loading"]),l(n,{class:"w-full ml-0!",onClick:se},{default:a(()=>[...e[20]||(e[20]=[u("重置",-1)])]),_:1})])]),_:1}),l(B,{span:16,class:"h-full overflow-y-auto pl-2 flex flex-col"},{default:a(()=>[d("h3",tt,[e[22]||(e[22]=d("span",null,"模块授权 (Module Selection)",-1)),d("span",lt,"已选: "+f(y.value.filter(t=>t.selected).length),1)]),l(de,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=t=>S.value=t),class:"flex-1 overflow-hidden flex flex-col"},{default:a(()=>[l(J,{label:"系统功能",name:"system",class:"h-full overflow-y-auto pr-2"},{default:a(()=>[d("div",at,[(c(!0),g(H,null,W(q.value,t=>(c(),g("div",{key:t.id,class:X(["border rounded-lg p-4 transition-all duration-200",t.selected?"border-primary-200 bg-primary-50/10":"border-gray-200 opacity-80"])},[d("div",ot,[l(F,{modelValue:t.selected,"onUpdate:modelValue":p=>t.selected=p,class:"!mr-0",disabled:t.module_code==="sys_core"},{default:a(()=>[d("span",st,f(t.module_name_cn||t.module_name),1),d("span",nt,"("+f(t.module_name)+")",1)]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),l($,{type:t.module_type==="SYSTEM"?"danger":"info",size:"small",effect:"plain"},{default:a(()=>[u(f(t.module_type),1)]),_:2},1032,["type"])]),t.selected?(c(),g("div",dt,[d("div",rt,[l(R,{modelValue:t.expire_type,"onUpdate:modelValue":p=>t.expire_type=p,size:"small",disabled:t.module_code==="sys_core"},{default:a(()=>[l(D,{value:"PERMANENT",disabled:o.license_type==="TRIAL"&&t.module_code!=="sys_core"},{default:a(()=>[...e[23]||(e[23]=[u("永久有效",-1)])]),_:2},1032,["disabled"]),l(D,{value:"DATE"},{default:a(()=>[...e[24]||(e[24]=[u("指定日期",-1)])]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),t.expire_type==="DATE"?(c(),V(L,{key:0,modelValue:t.custom_date,"onUpdate:modelValue":p=>t.custom_date=p,type:"date",placeholder:"选择过期日期",size:"small",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"!w-40","disabled-date":h,disabled:t.module_code==="sys_core"},null,8,["modelValue","onUpdate:modelValue","disabled"])):b("",!0)])])):b("",!0)],2))),128)),q.value.length===0&&!w.value?(c(),V(G,{key:0,description:"暂无系统功能模块"})):b("",!0)])]),_:1}),l(J,{label:"插件",name:"plugin",class:"h-full overflow-y-auto pr-2"},{default:a(()=>[d("div",ut,[(c(!0),g(H,null,W(j.value,t=>(c(),g("div",{key:t.id,class:X(["border rounded-lg p-4 transition-all duration-200",t.selected?"border-primary-200 bg-primary-50/10":"border-gray-200 opacity-80"])},[d("div",it,[l(F,{modelValue:t.selected,"onUpdate:modelValue":p=>t.selected=p,class:"!mr-0"},{default:a(()=>[d("span",ct,f(t.module_name_cn||t.module_name),1),d("span",mt,"("+f(t.module_name)+")",1)]),_:2},1032,["modelValue","onUpdate:modelValue"]),l($,{type:t.module_type==="SYSTEM"?"danger":"info",size:"small",effect:"plain"},{default:a(()=>[u(f(t.module_type),1)]),_:2},1032,["type"])]),t.selected?(c(),g("div",_t,[d("div",pt,[l(R,{modelValue:t.expire_type,"onUpdate:modelValue":p=>t.expire_type=p,size:"small"},{default:a(()=>[l(D,{value:"PERMANENT",disabled:o.license_type==="TRIAL"&&t.module_code!=="sys_core"},{default:a(()=>[...e[25]||(e[25]=[u("永久有效",-1)])]),_:2},1032,["disabled"]),l(D,{value:"DATE"},{default:a(()=>[...e[26]||(e[26]=[u("指定日期",-1)])]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"]),t.expire_type==="DATE"?(c(),V(L,{key:0,modelValue:t.custom_date,"onUpdate:modelValue":p=>t.custom_date=p,type:"date",placeholder:"选择过期日期",size:"small",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"!w-40","disabled-date":h},null,8,["modelValue","onUpdate:modelValue"])):b("",!0)])])):b("",!0)],2))),128)),j.value.length===0&&!w.value?(c(),V(G,{key:0,description:"暂无插件模块"})):b("",!0)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model"])),[[ce,w.value]])]),_:1})])}}}),ft="commercial_generate",yt={title:"commercial_generate",i18nKey:"route.commercial_generate",hideInMenu:!0},Z={name:ft,meta:yt};typeof Z=="function"&&Z(Q);const Dt=Oe(Q,[["__scopeId","data-v-09aff000"]]);export{Dt as default};
