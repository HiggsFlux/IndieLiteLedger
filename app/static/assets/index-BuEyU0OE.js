import{d as G,r as V,ag as pe,ap as ae,c as L,o as p,w as e,f as t,y as oe,p as ne,ah as ce,b as $,W as Y,X as q,ai as me,a4 as Me,a5 as Ue,g as d,t as c,q as re,az as ye,e as l,E as J,ar as _e,ad as P,a as H,O as ge,a9 as le,K as Te,P as we,aj as he,ak as xe,h as Oe,ac as ke,R as se,am as fe,aB as Re,af as ze,G as S,a0 as Be,a1 as je,U as We,V as He,aG as Ye,ae as De,N as qe,a3 as Ke,J as Fe,a2 as Ge,x as be,aH as Je,aI as Xe,v as Qe,aJ as Ze,aK as et,aL as tt,aM as lt,al as at}from"./index-CN2tD0BG.js";import{c as ot,u as Ve,f as nt,a as rt,d as st,b as it,e as dt,g as ut,h as pt,i as ct,v as mt}from"./order-Cf5wmHeH.js";import{b as _t}from"./client-RQjbOwKz.js";const ft={class:"dialog-footer"},vt=G({__name:"OrderForm",props:{visible:{type:Boolean},operateType:{},rowData:{}},emits:["update:visible","submitted"],setup(O,{emit:M}){const n=O,C=M,y=V(),E=V(!1),D=V([]),I=V(!1),i=pe({client_id:"",product_info:"",amount:0,order_type:"NEW",contract_no:"",remark:""}),w={client_id:[{required:!0,message:"请选择客户",trigger:"change"}],product_info:[{required:!0,message:"请输入购买内容",trigger:"blur"}],amount:[{required:!0,message:"请输入应收金额",trigger:"blur"}],order_type:[{required:!0,message:"请选择订单类型",trigger:"change"}]},f=[{label:"新购",value:"NEW"},{label:"续费",value:"RENEW"},{label:"增购",value:"UPSELL"},{label:"人工服务",value:"SERVICE"},{label:"项目实施",value:"IMPLEMENTATION"}];ae(()=>n.visible,b=>{b&&(n.operateType==="edit"&&n.rowData?(Object.assign(i,{client_id:n.rowData.client_id,product_info:n.rowData.product_info,amount:n.rowData.amount,order_type:n.rowData.order_type,contract_no:n.rowData.contract_no,remark:n.rowData.remark}),D.value=[{label:n.rowData.client_name,value:n.rowData.client_id}]):(Object.assign(i,{client_id:"",product_info:"",amount:0,order_type:"NEW",contract_no:"",remark:""}),D.value=[]))});async function s(b){if(b){I.value=!0;try{const{data:u}=await _t({name:b,current:1,size:20});if(u){const A=Array.isArray(u)?u:u.items||u.records||[];D.value=A.map(g=>({label:g.name,value:g.id}))}}finally{I.value=!1}}else D.value=[]}async function r(){await y.value?.validate(),E.value=!0;try{n.operateType==="add"?(await ot(i),P.success("创建成功")):n.operateType==="edit"&&n.rowData&&(await Ve(n.rowData.id,i),P.success("更新成功")),C("submitted"),C("update:visible",!1)}finally{E.value=!1}}return(b,u)=>{const A=me,g=ce,h=ne,R=Ue,N=Me,j=re,x=ye,m=oe,z=J,U=_e;return p(),L(U,{"model-value":b.visible,title:b.operateType==="add"?"新建订单":"编辑订单",width:"600px","onUpdate:modelValue":u[7]||(u[7]=k=>C("update:visible",k))},{footer:e(()=>[l("span",ft,[t(z,{onClick:u[6]||(u[6]=k=>C("update:visible",!1))},{default:e(()=>[...u[8]||(u[8]=[d("取消",-1)])]),_:1}),t(z,{type:"primary",loading:E.value,onClick:r},{default:e(()=>[...u[9]||(u[9]=[d("确定",-1)])]),_:1},8,["loading"])])]),default:e(()=>[t(m,{ref_key:"formRef",ref:y,model:i,rules:w,"label-width":"100px"},{default:e(()=>[t(h,{label:"客户",prop:"client_id"},{default:e(()=>[t(g,{modelValue:i.client_id,"onUpdate:modelValue":u[0]||(u[0]=k=>i.client_id=k),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入客户名称搜索","remote-method":s,loading:I.value,style:{width:"100%"},disabled:b.operateType==="edit"},{default:e(()=>[(p(!0),$(Y,null,q(D.value,k=>(p(),L(A,{key:k.value,label:k.label,value:k.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1}),t(h,{label:"订单类型",prop:"order_type"},{default:e(()=>[t(N,{modelValue:i.order_type,"onUpdate:modelValue":u[1]||(u[1]=k=>i.order_type=k)},{default:e(()=>[(p(),$(Y,null,q(f,k=>t(R,{key:k.value,label:k.value},{default:e(()=>[d(c(k.label),1)]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"])]),_:1}),t(h,{label:"购买内容",prop:"product_info"},{default:e(()=>[t(j,{modelValue:i.product_info,"onUpdate:modelValue":u[2]||(u[2]=k=>i.product_info=k),type:"textarea",rows:3,placeholder:"例如：TalkMyData 企业版永久授权 x1"},null,8,["modelValue"])]),_:1}),t(h,{label:"应收金额",prop:"amount"},{default:e(()=>[t(x,{modelValue:i.amount,"onUpdate:modelValue":u[3]||(u[3]=k=>i.amount=k),precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(h,{label:"关联合同号",prop:"contract_no"},{default:e(()=>[t(j,{modelValue:i.contract_no,"onUpdate:modelValue":u[4]||(u[4]=k=>i.contract_no=k),placeholder:"可选"},null,8,["modelValue"])]),_:1}),t(h,{label:"备注",prop:"remark"},{default:e(()=>[t(j,{modelValue:i.remark,"onUpdate:modelValue":u[5]||(u[5]=k=>i.remark=k),type:"textarea",placeholder:"可选"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["model-value","title"])}}}),bt={class:"flex flex-col gap-4"},yt={class:"bg-gray-50 p-4 rounded border border-gray-200"},gt={class:"flex justify-between items-center mb-2"},wt={class:"flex gap-8"},ht={class:"text-lg font-bold"},xt={class:"text-lg font-bold text-gray-500"},kt={class:"flex gap-2"},Dt={class:"w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2"},Vt={class:"text-right text-xs text-gray-400 mt-1"},Et={key:0,class:"font-bold text-green-600"},Ct={key:1,class:"font-bold text-red-600"},At={key:0,class:"text-xs text-gray-400 mt-1"},$t={key:1,class:"text-xs text-gray-400 mt-1"},Lt=G({__name:"PaymentTab",props:{orderId:{},orderAmount:{}},emits:["update:order"],setup(O,{emit:M}){const n=O,C=M,y=V(!1),E=V([]),D=V(!1),I=V(!1),i=V(1),w=V({amount:0,type:1,pay_method:"BANK",transaction_id:"",remark:""}),f=[{label:"对公转账",value:"BANK"},{label:"微信支付",value:"WECHAT"},{label:"支付宝",value:"ALIPAY"},{label:"现金",value:"CASH"}],s=[{label:"原路退回",value:"BANK"},{label:"微信退款",value:"WECHAT"},{label:"支付宝退款",value:"ALIPAY"},{label:"现金退款",value:"CASH"}],r=H(()=>E.value.filter(x=>x.type===1).reduce((x,m)=>x+Number(m.amount),0)),b=H(()=>E.value.filter(x=>x.type===2).reduce((x,m)=>x+Number(m.amount),0)),u=H(()=>r.value-b.value),A=H(()=>Math.max(0,n.orderAmount-u.value)),g=H(()=>{if(n.orderAmount<=0)return 100;const x=u.value/n.orderAmount*100;return Math.min(100,Math.max(0,x))});async function h(){y.value=!0;try{const{data:x}=await nt(n.orderId);x&&(E.value=x)}finally{y.value=!1}}function R(x){i.value=x,w.value={amount:x===1?A.value:0,type:x,pay_method:"BANK",transaction_id:"",remark:""},D.value=!0}async function N(){if(w.value.amount<=0){P.warning("金额必须大于0");return}if(w.value.type===2&&w.value.amount>u.value){P.warning("退款金额不能大于净实收金额");return}I.value=!0;try{const{data:x}=await rt(n.orderId,w.value);x&&(P.success(w.value.type===1?"收款登记成功":"退款登记成功"),D.value=!1,h(),C("update:order"))}finally{I.value=!1}}async function j(x){try{await fe.confirm("确定要删除这条记录吗？这将影响订单状态。","警告",{type:"warning"}),await st(n.orderId,x.id),P.success("删除成功"),h(),C("update:order")}catch{}}return ae(()=>n.orderId,()=>{n.orderId&&h()},{immediate:!0}),(x,m)=>{const z=J,U=xe,k=se,ie=he,Z=ye,K=ne,v=me,o=ce,W=re,X=oe,de=_e,ee=we;return p(),$("div",bt,[l("div",yt,[l("div",gt,[l("div",wt,[l("div",null,[m[8]||(m[8]=l("div",{class:"text-xs text-gray-500 mb-1"},"应收总额",-1)),l("div",ht,"¥"+c(Math.round(x.orderAmount).toLocaleString()),1)]),l("div",null,[m[9]||(m[9]=l("div",{class:"text-xs text-gray-500 mb-1"},"净实收 (Net Paid)",-1)),l("div",{class:le(["text-lg font-bold",u.value>=x.orderAmount?"text-green-600":"text-blue-600"])}," ¥"+c(Math.round(u.value).toLocaleString()),3)]),l("div",null,[m[10]||(m[10]=l("div",{class:"text-xs text-gray-500 mb-1"},"待收",-1)),l("div",xt,"¥"+c(Math.round(A.value).toLocaleString()),1)])]),l("div",kt,[t(z,{type:"primary",onClick:m[0]||(m[0]=_=>R(1)),disabled:A.value<=0},{default:e(()=>[...m[11]||(m[11]=[l("div",{class:"i-ep-plus mr-1"},null,-1),d(" 登记收款 ",-1)])]),_:1},8,["disabled"]),t(z,{type:"danger",plain:"",onClick:m[1]||(m[1]=_=>R(2)),disabled:u.value<=0},{default:e(()=>[...m[12]||(m[12]=[l("div",{class:"i-ep-minus mr-1"},null,-1),d(" 登记退款 ",-1)])]),_:1},8,["disabled"])])]),l("div",Dt,[l("div",{class:le(["bg-blue-600 h-2.5 rounded-full",{"bg-green-500":g.value>=100}]),style:Te({width:`${g.value}%`})},null,6)]),l("div",Vt,c(g.value.toFixed(0))+"% 已结清",1)]),ge((p(),L(ie,{data:E.value,border:"",size:"small"},{default:e(()=>[t(U,{label:"时间",width:"160"},{default:e(({row:_})=>[d(c(Oe(ke)(_.pay_time).format("YYYY-MM-DD HH:mm")),1)]),_:1}),t(U,{label:"类型",width:"80",align:"center"},{default:e(({row:_})=>[t(k,{type:_.type===1?"success":"danger",size:"small"},{default:e(()=>[d(c(_.type===1?"收款":"退款"),1)]),_:2},1032,["type"])]),_:1}),t(U,{label:"金额",width:"120"},{default:e(({row:_})=>[_.type===1?(p(),$("span",Et,"+¥"+c(Math.round(_.amount).toLocaleString()),1)):(p(),$("span",Ct,"-¥"+c(Math.round(_.amount).toLocaleString()),1))]),_:1}),t(U,{prop:"pay_method",label:"方式",width:"100"},{default:e(({row:_})=>[t(k,{size:"small",effect:"plain"},{default:e(()=>[d(c(f.find(Q=>Q.value===_.pay_method)?.label||_.pay_method),1)]),_:2},1024)]),_:1}),t(U,{prop:"transaction_id",label:"流水号","min-width":"150","show-overflow-tooltip":""}),t(U,{prop:"remark",label:"备注","min-width":"150","show-overflow-tooltip":""}),t(U,{label:"操作",width:"80",align:"center"},{default:e(({row:_})=>[t(z,{link:"",type:"danger",size:"small",onClick:Q=>j(_)},{default:e(()=>[...m[13]||(m[13]=[d("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,y.value]]),t(de,{modelValue:D.value,"onUpdate:modelValue":m[7]||(m[7]=_=>D.value=_),title:i.value===1?"登记收款":"登记退款",width:"500px","append-to-body":""},{footer:e(()=>[t(z,{onClick:m[6]||(m[6]=_=>D.value=!1)},{default:e(()=>[...m[14]||(m[14]=[d("取消",-1)])]),_:1}),t(z,{type:i.value===1?"primary":"danger",loading:I.value,onClick:N},{default:e(()=>[d(c(i.value===1?"确认登记":"确认退款"),1)]),_:1},8,["type","loading"])]),default:e(()=>[t(X,{model:w.value,"label-width":"100px"},{default:e(()=>[t(K,{label:i.value===1?"收款金额":"退款金额",required:""},{default:e(()=>[t(Z,{modelValue:w.value.amount,"onUpdate:modelValue":m[2]||(m[2]=_=>w.value.amount=_),min:.01,max:i.value===1?A.value:u.value,precision:2,style:{width:"100%"}},null,8,["modelValue","max"]),i.value===1?(p(),$("div",At,"本次最多可收: ¥"+c(A.value),1)):(p(),$("div",$t,"本次最多可退: ¥"+c(u.value),1))]),_:1},8,["label"]),t(K,{label:i.value===1?"支付方式":"退款方式",required:""},{default:e(()=>[t(o,{modelValue:w.value.pay_method,"onUpdate:modelValue":m[3]||(m[3]=_=>w.value.pay_method=_),style:{width:"100%"}},{default:e(()=>[(p(!0),$(Y,null,q(i.value===1?f:s,_=>(p(),L(v,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),t(K,{label:i.value===1?"交易流水号":"退款单号"},{default:e(()=>[t(W,{modelValue:w.value.transaction_id,"onUpdate:modelValue":m[4]||(m[4]=_=>w.value.transaction_id=_),placeholder:i.value===1?"请输入外部交易单号":"请输入退款单号"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t(K,{label:"备注",required:i.value===2},{default:e(()=>[t(W,{modelValue:w.value.remark,"onUpdate:modelValue":m[5]||(m[5]=_=>w.value.remark=_),type:"textarea",rows:2,placeholder:i.value===1?"例如：首付款30%":"请输入退款原因"},null,8,["modelValue","placeholder"])]),_:1},8,["required"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),It={class:"flex flex-col gap-4"},Nt={class:"flex justify-between items-center bg-gray-50 p-4 rounded border border-gray-200"},St={key:0,class:"text-center py-8 text-gray-400"},Pt={key:1,class:"grid grid-cols-1 gap-2"},Mt={class:"flex items-center gap-3 overflow-hidden"},Ut={class:"flex flex-col min-w-0"},Tt=["title"],Ot={class:"text-xs text-gray-400 uppercase"},Rt={class:"flex items-center gap-2 flex-shrink-0"},zt=G({__name:"AttachmentTab",props:{orderId:{},initialAttachments:{}},emits:["update:order"],setup(O,{emit:M}){const n=O,C=M,y=V([]),E=V(!1);ae(()=>n.initialAttachments,s=>{if(s)try{y.value=JSON.parse(s)}catch{y.value=[]}else y.value=[]},{immediate:!0});async function D(s){const{file:r}=s;E.value=!0;try{const{data:b}=await it(r);b&&(y.value.push(b),await i(),P.success("上传成功"))}catch{P.error("上传失败")}finally{E.value=!1}}async function I(s){try{await fe.confirm("确定要删除这个附件吗？","提示",{type:"warning"}),y.value.splice(s,1),await i(),P.success("删除成功")}catch{}}async function i(){await Ve(n.orderId,{attachments:JSON.stringify(y.value)}),C("update:order")}function w(s){const r=document.createElement("a");r.href="/api/v1"+s.url,r.target="_blank",r.download=s.name,document.body.appendChild(r),r.click(),document.body.removeChild(r)}function f(s){return["jpg","jpeg","png","gif"].includes(s.toLowerCase())?"i-ep-picture":["pdf"].includes(s.toLowerCase())?"i-ep-document":["zip","rar","7z"].includes(s.toLowerCase())?"i-ep-box":"i-ep-paperclip"}return(s,r)=>{const b=J,u=Re;return p(),$("div",It,[l("div",Nt,[r[1]||(r[1]=l("div",{class:"text-sm text-gray-500"}," 支持上传合同扫描件、验收单、发票截图等文件。 ",-1)),t(u,{action:"","http-request":D,"show-file-list":!1,disabled:E.value,accept:".pdf,.jpg,.jpeg,.png,.zip,.rar,.doc,.docx"},{default:e(()=>[t(b,{type:"primary",loading:E.value},{default:e(()=>[...r[0]||(r[0]=[l("div",{class:"i-ep-upload mr-1"},null,-1),d(" 上传附件 ",-1)])]),_:1},8,["loading"])]),_:1},8,["disabled"])]),y.value.length===0?(p(),$("div",St," 暂无附件 ")):(p(),$("div",Pt,[(p(!0),$(Y,null,q(y.value,(A,g)=>(p(),$("div",{key:g,class:"flex items-center justify-between p-3 border rounded hover:bg-gray-50"},[l("div",Mt,[l("div",{class:le([f(A.type),"text-2xl text-primary"])},null,2),l("div",Ut,[l("span",{class:"font-medium truncate",title:A.name},c(A.name),9,Tt),l("span",Ot,c(A.type)+" FILE",1)])]),l("div",Rt,[t(b,{link:"",type:"primary",onClick:h=>w(A)},{default:e(()=>[...r[2]||(r[2]=[d("下载",-1)])]),_:2},1032,["onClick"]),t(b,{link:"",type:"danger",onClick:h=>I(g)},{default:e(()=>[...r[3]||(r[3]=[d("删除",-1)])]),_:2},1032,["onClick"])])]))),128))]))])}}}),Bt={key:0,class:"flex flex-col h-full"},jt={class:"flex justify-between items-center mb-4 p-4 bg-gray-50 rounded"},Wt={class:"flex gap-4 items-center"},Ht={class:"font-bold text-lg"},Yt={class:"text-gray-500"},qt={class:"font-bold text-black"},Kt={class:"flex flex-col gap-6"},Ft={key:0},Gt={class:"p-4 bg-gray-50 rounded border border-gray-200"},Jt={key:0,class:"mt-4"},Xt={key:1},Qt={class:"text-gray-600 bg-gray-50 p-2 rounded"},Zt=G({__name:"OrderDetailDrawer",props:{visible:{type:Boolean},rowData:{}},emits:["update:visible","submitted"],setup(O,{emit:M}){const n=O,C=M,y=ze(),E=V("info"),D=!1,I=H(()=>n.rowData?.status==="PAID"&&["NEW","RENEW","UPSELL"].includes(n.rowData?.order_type||"")),i={PENDING:{label:"待支付",type:"warning"},PARTIAL:{label:"部分付款",type:"warning"},PAID:{label:"已支付",type:"success"},CANCELLED:{label:"已作废",type:"info"},REFUNDING:{label:"退款中",type:"danger"}};async function w(){n.rowData&&y.push({path:"/license/generate",query:{clientId:n.rowData.client_id,orderNo:n.rowData.order_no}})}return(f,s)=>{const r=se,b=He,u=We,A=J,g=je,h=Be,R=Ye;return p(),L(R,{"model-value":f.visible,title:"订单详情",size:"800px","onUpdate:modelValue":s[3]||(s[3]=N=>C("update:visible",N))},{default:e(()=>[f.rowData?(p(),$("div",Bt,[l("div",jt,[l("div",Wt,[l("span",Ht,c(f.rowData.order_no),1),t(r,{type:i[f.rowData.status]?.type||"info"},{default:e(()=>[d(c(i[f.rowData.status]?.label||f.rowData.status),1)]),_:1},8,["type"])]),l("div",Yt,[s[4]||(s[4]=d(" 总金额: ",-1)),l("span",qt,"¥"+c(Math.round(f.rowData.amount).toLocaleString()),1)])]),t(h,{modelValue:E.value,"onUpdate:modelValue":s[2]||(s[2]=N=>E.value=N),class:"flex-1 flex flex-col min-h-0"},{default:e(()=>[t(g,{label:"基础信息",name:"info",class:"overflow-auto h-full pr-2"},{default:e(()=>[l("div",Kt,[t(u,{title:"基础信息",column:2,border:""},{default:e(()=>[t(b,{label:"订单号"},{default:e(()=>[d(c(f.rowData.order_no),1)]),_:1}),t(b,{label:"状态"},{default:e(()=>[d(c(i[f.rowData.status]?.label||f.rowData.status),1)]),_:1}),t(b,{label:"应收金额"},{default:e(()=>[d("¥"+c(Math.round(f.rowData.amount).toLocaleString()),1)]),_:1}),t(b,{label:"实收金额"},{default:e(()=>[d("¥"+c(Math.round(f.rowData.actual_amount).toLocaleString()),1)]),_:1}),t(b,{label:"类型"},{default:e(()=>[d(c(f.rowData.order_type),1)]),_:1}),t(b,{label:"支付方式"},{default:e(()=>[d(c(f.rowData.pay_method),1)]),_:1}),t(b,{label:"创建时间"},{default:e(()=>[d(c(f.rowData.created_at),1)]),_:1}),t(b,{label:"合同号"},{default:e(()=>[d(c(f.rowData.contract_no||"-"),1)]),_:1})]),_:1}),t(u,{title:"客户信息",column:1,border:""},{default:e(()=>[t(b,{label:"客户名称"},{default:e(()=>[d(c(f.rowData.client_name),1)]),_:1})]),_:1}),D?(p(),$("div",Ft,[s[7]||(s[7]=l("h3",{class:"font-bold text-base mb-2"},"关联资产 (Licenses)",-1)),l("div",Gt,[s[6]||(s[6]=l("p",{class:"text-gray-500 text-sm mb-2"},"该订单包含的授权信息。",-1)),I.value?(p(),$("div",Jt,[t(A,{type:"warning",onClick:w},{default:e(()=>[...s[5]||(s[5]=[l("div",{class:"i-ep-lightning mr-1"},null,-1),d(" 为此订单生成授权 ",-1)])]),_:1})])):S("",!0)])])):S("",!0),f.rowData.remark?(p(),$("div",Xt,[s[8]||(s[8]=l("h3",{class:"font-bold text-base mb-2"},"备注",-1)),l("p",Qt,c(f.rowData.remark),1)])):S("",!0)])]),_:1}),t(g,{label:"资金/回款",name:"payment",class:"overflow-auto h-full pr-2"},{default:e(()=>[t(Lt,{"order-id":f.rowData.id,"order-amount":f.rowData.amount,"onUpdate:order":s[0]||(s[0]=N=>C("submitted"))},null,8,["order-id","order-amount"])]),_:1}),t(g,{label:"附件/合同",name:"attachment",class:"overflow-auto h-full pr-2"},{default:e(()=>[t(zt,{"order-id":f.rowData.id,"initial-attachments":f.rowData.attachments,"onUpdate:order":s[1]||(s[1]=N=>C("submitted"))},null,8,["order-id","initial-attachments"])]),_:1})]),_:1},8,["modelValue"])])):S("",!0)]),_:1},8,["model-value"])}}}),el=De(Zt,[["__scopeId","data-v-23e008fb"]]),tl={class:"mb-4"},ll=G({__name:"PaymentConfirmDialog",props:{visible:{type:Boolean},rowData:{}},emits:["update:visible","success"],setup(O,{emit:M}){const n=O,C=M,y=V(),E=V(!1),D=pe({external_transaction_no:""}),I={external_transaction_no:[{required:!0,message:"请输入交易流水号",trigger:"blur"}]},i=H(()=>{if(!n.rowData)return{label:"外部流水号",placeholder:"请输入外部流水号"};switch(n.rowData.pay_method){case"WECHAT":return{label:"微信支付单号",placeholder:"请输入微信支付凭证号 (42000...)"};case"ALIPAY":return{label:"支付宝交易号",placeholder:"请输入 28 位交易号"};case"BANK":return{label:"打款户名/回单号",placeholder:"请输入对方汇款账户名，以便财务查账"};default:return{label:"外部流水号",placeholder:"请输入外部流水号"}}}),w=H(()=>n.rowData?{WECHAT:"微信支付",ALIPAY:"支付宝",BANK:"对公转账",CASH:"现金"}[n.rowData.pay_method]||n.rowData.pay_method:"");ae(()=>n.visible,s=>{s&&n.rowData?D.external_transaction_no=n.rowData.external_transaction_no||"":D.external_transaction_no=""});async function f(){if(await y.value?.validate(),!!n.rowData){E.value=!0;try{await dt(n.rowData.id,"PAID",D.external_transaction_no),P.success("确认收款成功"),C("success"),C("update:visible",!1)}finally{E.value=!1}}}return(s,r)=>{const b=se,u=re,A=ne,g=oe,h=J,R=_e;return p(),L(R,{"model-value":s.visible,title:"确认收款",width:"500px","onUpdate:modelValue":r[2]||(r[2]=N=>C("update:visible",N))},{footer:e(()=>[t(h,{onClick:r[1]||(r[1]=N=>C("update:visible",!1))},{default:e(()=>[...r[5]||(r[5]=[d("取消",-1)])]),_:1}),t(h,{type:"primary",loading:E.value,onClick:f},{default:e(()=>[...r[6]||(r[6]=[d("确认收款",-1)])]),_:1},8,["loading"])]),default:e(()=>[l("div",tl,[l("p",null,[r[3]||(r[3]=d("当前支付方式： ",-1)),t(b,null,{default:e(()=>[d(c(w.value),1)]),_:1})]),r[4]||(r[4]=l("p",{class:"text-gray-500 text-sm mt-1"},"请核对支付方式并录入对应的交易流水号。",-1))]),t(g,{ref_key:"formRef",ref:y,model:D,rules:I,"label-width":"120px"},{default:e(()=>[t(A,{label:i.value.label,prop:"external_transaction_no"},{default:e(()=>[t(u,{modelValue:D.external_transaction_no,"onUpdate:modelValue":r[0]||(r[0]=N=>D.external_transaction_no=N),placeholder:i.value.placeholder},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["model-value"])}}}),al={class:"h-full overflow-hidden flex flex-col p-4 gap-4"},ol={class:"text-2xl font-bold"},nl={class:"text-2xl font-bold text-orange-500"},rl={class:"text-2xl font-bold"},sl={class:"mb-4 flex justify-between items-center"},il={class:"flex items-center justify-center gap-2"},dl=["onClick"],ul={key:0,class:"text-xs text-gray-400"},pl={class:"font-bold"},cl={class:"flex items-center justify-center"},ml={class:"el-dropdown-link flex items-center"},_l={class:"mt-4 flex justify-end"},fl=G({name:"order_list",__name:"index",setup(O){const M=V(!1),n=V([]),C=V({monthly_revenue:0,pending_amount:0,monthly_count:0}),y=V({status:void 0,client_name:"",order_no:"",pay_method:void 0}),E=V(!1),D=V(!1),I=V(!1),i=V("add"),w=V(null),f=V([{label:"订单号",prop:"order_no",visible:!0,minWidth:"180",align:"center"},{label:"客户名称",prop:"client_name",visible:!0,minWidth:"150",showOverflowTooltip:!0},{label:"客户类型",prop:"client_type",visible:!0,width:"100",align:"center"},{label:"购买内容",prop:"product_info",visible:!0,minWidth:"200",showOverflowTooltip:!0,align:"left",headerAlign:"left",className:"col-custom-left"},{label:"金额",prop:"amount",visible:!0,width:"120",align:"right",headerAlign:"right",className:"col-custom-right"},{label:"类型",prop:"order_type",visible:!0,width:"100"},{label:"状态",prop:"status",visible:!0,width:"100"},{label:"支付方式",prop:"pay_method",visible:!0,width:"100",align:"center"},{label:"创建时间",prop:"created_at",visible:!0,width:"160"}]),s=V(f.value.map(v=>v.prop));function r(v){return s.value.includes(v)}const b={PENDING:{label:"待支付",type:"warning"},PARTIAL:{label:"部分付款",type:"warning"},PAID:{label:"已支付",type:"success"},REFUND_PART:{label:"部分退款",type:"danger"},REFUNDED:{label:"已全退",type:"danger"},VOID:{label:"已作废",type:"info"}},u={NEW:"新购",RENEW:"续费",UPSELL:"增购",SERVICE:"人工服务",IMPLEMENTATION:"项目实施"},A={WECHAT:"微信",ALIPAY:"支付宝",BANK:"银行转账",CASH:"现金"},g=pe({currentPage:1,pageSize:20,total:0});async function h(){M.value=!0;try{const{data:v}=await ut({...y.value,skip:(g.currentPage-1)*g.pageSize,limit:g.pageSize});v&&(Array.isArray(v)?(n.value=v,g.total=v.length):v.items?(n.value=v.items,g.total=v.total||v.items.length):n.value=v);const o=await pt();o.data&&(C.value=o.data)}finally{M.value=!1}}function R(v){g.pageSize=v,h()}function N(v){g.currentPage=v,h()}function j(){g.currentPage=1,h()}function x(){y.value={status:void 0,client_name:"",order_no:"",pay_method:void 0},g.currentPage=1,h()}function m(){i.value="add",w.value=null,E.value=!0}function z(v){i.value="edit",w.value=v,E.value=!0}function U(v){w.value=v,D.value=!0}async function k(v){if(!v.is_invoiced)try{await ct(v.id,!0),P.success("已标记为已开票"),h()}catch{}}async function ie(v){if(v.total_paid>0){P.warning("该订单已产生资金流水，请先将款项全部退回/删除收款记录后，再进行作废操作。");return}try{await fe.confirm("确定要作废此订单吗？作废后不可恢复。","警告",{type:"warning",confirmButtonText:"确认作废",cancelButtonText:"取消"}),await mt(v.id),P.success("订单已作废"),h()}catch{}}function Z(v){navigator.clipboard.writeText(v.order_no),P.success("订单号已复制")}function K(v){return v?ke(v).format("YYYY-MM-DD HH:mm"):"-"}return qe(()=>{h()}),(v,o)=>{const W=Fe,X=Ke,de=Ge,ee=re,_=ne,Q=me,ve=ce,F=J,Ee=oe,Ce=Qe,Ae=Xe,$e=Je,B=xe,ue=se,te=lt,Le=tt,Ie=et,Ne=he,Se=at,Pe=we;return p(),$("div",al,[t(de,{gutter:20},{default:e(()=>[t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...o[10]||(o[10]=[l("div",{class:"card-header"},[l("span",null,"本月成交额")],-1)])]),default:e(()=>[l("div",ol,"¥ "+c(Math.round(C.value.monthly_revenue).toLocaleString()),1)]),_:1})]),_:1}),t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...o[11]||(o[11]=[l("div",{class:"card-header"},[l("span",null,"待回款金额")],-1)])]),default:e(()=>[l("div",nl,"¥ "+c(Math.round(C.value.pending_amount).toLocaleString()),1)]),_:1})]),_:1}),t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...o[12]||(o[12]=[l("div",{class:"card-header"},[l("span",null,"本月订单数")],-1)])]),default:e(()=>[l("div",rl,c(C.value.monthly_count),1)]),_:1})]),_:1})]),_:1}),t(W,{shadow:"never",class:"flex-none"},{default:e(()=>[t(Ee,{inline:!0,model:y.value},{default:e(()=>[t(_,{label:"订单号"},{default:e(()=>[t(ee,{modelValue:y.value.order_no,"onUpdate:modelValue":o[0]||(o[0]=a=>y.value.order_no=a),placeholder:"输入订单号",clearable:"",onKeyup:be(j,["enter"])},null,8,["modelValue"])]),_:1}),t(_,{label:"客户名称"},{default:e(()=>[t(ee,{modelValue:y.value.client_name,"onUpdate:modelValue":o[1]||(o[1]=a=>y.value.client_name=a),placeholder:"输入客户名称",clearable:"",onKeyup:be(j,["enter"])},null,8,["modelValue"])]),_:1}),t(_,{label:"支付方式"},{default:e(()=>[t(ve,{modelValue:y.value.pay_method,"onUpdate:modelValue":o[2]||(o[2]=a=>y.value.pay_method=a),placeholder:"选择支付方式",clearable:"",style:{width:"150px"}},{default:e(()=>[(p(),$(Y,null,q(A,(a,T)=>t(Q,{key:T,label:a,value:T},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"状态"},{default:e(()=>[t(ve,{modelValue:y.value.status,"onUpdate:modelValue":o[3]||(o[3]=a=>y.value.status=a),placeholder:"选择状态",clearable:"",style:{width:"150px"}},{default:e(()=>[(p(),$(Y,null,q(b,(a,T)=>t(Q,{key:T,label:a.label,value:T},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(_,null,{default:e(()=>[t(F,{type:"primary",onClick:j},{default:e(()=>[...o[13]||(o[13]=[d("搜索",-1)])]),_:1}),t(F,{onClick:x},{default:e(()=>[...o[14]||(o[14]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(W,{shadow:"never",class:"flex-1 flex flex-col min-h-0"},{default:e(()=>[l("div",sl,[t(F,{type:"primary",onClick:m},{default:e(()=>[...o[15]||(o[15]=[d("新建订单",-1)])]),_:1}),t($e,{placement:"bottom",title:"列设置",trigger:"click",width:200},{reference:e(()=>[t(F,null,{default:e(()=>[...o[16]||(o[16]=[l("div",{class:"i-ep-setting text-lg"},null,-1)])]),_:1})]),default:e(()=>[t(Ae,{modelValue:s.value,"onUpdate:modelValue":o[4]||(o[4]=a=>s.value=a),min:1,class:"flex flex-col gap-2"},{default:e(()=>[(p(!0),$(Y,null,q(f.value,a=>(p(),L(Ce,{key:a.prop,label:a.prop,value:a.prop},{default:e(()=>[d(c(a.label),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),ge((p(),L(Ne,{data:n.value,border:"",style:{width:"100%",height:"100%"}},{default:e(()=>[r("order_no")?(p(),L(B,{key:0,prop:"order_no",label:"订单号","min-width":"180",align:"center"},{default:e(({row:a})=>[l("div",il,[l("span",{class:le(["font-mono font-bold",{"line-through text-gray-400":a.status==="VOID"}])},c(a.order_no),3),l("div",{class:"i-ep-document-copy cursor-pointer text-gray-400 hover:text-primary",onClick:Ze(T=>Z(a),["stop"])},null,8,dl)]),a.contract_no?(p(),$("div",ul,"合同: "+c(a.contract_no),1)):S("",!0)]),_:1})):S("",!0),r("client_name")?(p(),L(B,{key:1,prop:"client_name",label:"客户名称","min-width":"150","show-overflow-tooltip":""})):S("",!0),r("client_type")?(p(),L(B,{key:2,prop:"client_type",label:"客户类型",width:"100",align:"center"},{default:e(({row:a})=>[t(ue,{type:a.client_type===1?"warning":"success",size:"small"},{default:e(()=>[d(c(a.client_type===1?"企业":"个人"),1)]),_:2},1032,["type"])]),_:1})):S("",!0),r("product_info")?(p(),L(B,{key:3,prop:"product_info",label:"购买内容","min-width":"200","show-overflow-tooltip":"",align:"left","header-align":"left","class-name":"col-custom-left"})):S("",!0),r("amount")?(p(),L(B,{key:4,prop:"amount",label:"金额",width:"120",align:"right","header-align":"right","class-name":"col-custom-right"},{default:e(({row:a})=>[l("span",pl,"¥"+c(Math.round(a.amount).toLocaleString()),1)]),_:1})):S("",!0),r("order_type")?(p(),L(B,{key:5,prop:"order_type",label:"类型",width:"100"},{default:e(({row:a})=>[t(ue,null,{default:e(()=>[d(c(u[a.order_type]||a.order_type),1)]),_:2},1024)]),_:1})):S("",!0),r("status")?(p(),L(B,{key:6,prop:"status",label:"状态",width:"100"},{default:e(({row:a})=>[t(ue,{type:b[a.status]?.type||"info"},{default:e(()=>[d(c(b[a.status]?.label||a.status),1)]),_:2},1032,["type"])]),_:1})):S("",!0),r("pay_method")?(p(),L(B,{key:7,prop:"pay_method",label:"支付方式",width:"100",align:"center"},{default:e(({row:a})=>[d(c(A[a.pay_method]||a.pay_method),1)]),_:1})):S("",!0),r("created_at")?(p(),L(B,{key:8,prop:"created_at",label:"创建时间",width:"160"},{default:e(({row:a})=>[d(c(K(a.created_at)),1)]),_:1})):S("",!0),t(B,{label:"操作",width:"150",fixed:"right",align:"center"},{default:e(({row:a})=>[l("div",cl,[t(F,{link:"",type:"primary",onClick:T=>U(a)},{default:e(()=>[...o[17]||(o[17]=[d("详情",-1)])]),_:2},1032,["onClick"]),a.status!=="VOID"?(p(),L(Ie,{key:0,trigger:"click",class:"ml-2 flex items-center"},{dropdown:e(()=>[t(Le,null,{default:e(()=>[t(te,{onClick:T=>z(a)},{default:e(()=>[...o[19]||(o[19]=[d("编辑",-1)])]),_:2},1032,["onClick"]),a.is_invoiced?S("",!0):(p(),L(te,{key:0,onClick:T=>k(a)},{default:e(()=>[...o[20]||(o[20]=[d("标记已开票",-1)])]),_:2},1032,["onClick"])),t(te,{onClick:T=>Z(a)},{default:e(()=>[...o[21]||(o[21]=[d("复制单号",-1)])]),_:2},1032,["onClick"]),t(te,{divided:"",class:"text-red-500",onClick:T=>ie(a)},{default:e(()=>[...o[22]||(o[22]=[d("作废订单",-1)])]),_:2},1032,["onClick"])]),_:2},1024)]),default:e(()=>[l("span",ml,[t(F,{link:"",type:"primary"},{default:e(()=>[...o[18]||(o[18]=[d("操作",-1)])]),_:1})])]),_:2},1024)):S("",!0)])]),_:1})]),_:1},8,["data"])),[[Pe,M.value]]),l("div",_l,[t(Se,{"current-page":g.currentPage,"onUpdate:currentPage":o[5]||(o[5]=a=>g.currentPage=a),"page-size":g.pageSize,"onUpdate:pageSize":o[6]||(o[6]=a=>g.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:g.total,onSizeChange:R,onCurrentChange:N},null,8,["current-page","page-size","total"])])]),_:1}),t(vt,{visible:E.value,"onUpdate:visible":o[7]||(o[7]=a=>E.value=a),"operate-type":i.value,"row-data":w.value,onSubmitted:h},null,8,["visible","operate-type","row-data"]),t(el,{visible:D.value,"onUpdate:visible":o[8]||(o[8]=a=>D.value=a),"row-data":w.value,onSubmitted:h},null,8,["visible","row-data"]),t(ll,{visible:I.value,"onUpdate:visible":o[9]||(o[9]=a=>I.value=a),"row-data":w.value,onSuccess:h},null,8,["visible","row-data"])])}}}),gl=De(fl,[["__scopeId","data-v-478cf2c4"]]);export{gl as default};
