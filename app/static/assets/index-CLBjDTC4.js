import{d as G,r as V,ag as pe,ap as ae,c as L,o as c,w as e,f as t,y as oe,p as ne,ah as ce,b as $,W as Y,X as q,ai as me,a4 as Me,a5 as Ue,g as i,t as p,q as re,az as ye,e as l,E as J,ar as _e,ad as P,a as H,O as ge,a9 as le,K as Te,P as we,aj as he,ak as xe,h as Oe,ac as ke,R as se,am as fe,aB as Re,af as ze,G as N,a0 as Be,a1 as je,U as We,V as He,aG as Ye,ae as De,N as qe,a3 as Ke,J as Fe,a2 as Ge,x as be,aH as Je,aI as Xe,v as Qe,aJ as Ze,aK as et,aL as tt,aM as lt,al as at}from"./index-CcZaxT8H.js";import{c as ot,u as Ve,f as nt,a as rt,d as st,b as it,e as dt,g as ut,h as pt,i as ct,v as mt}from"./order-BkiGuLLk.js";import{b as _t}from"./client-BNDKmuV7.js";const ft={class:"dialog-footer"},vt=G({__name:"OrderForm",props:{visible:{type:Boolean},operateType:{},rowData:{}},emits:["update:visible","submitted"],setup(O,{emit:M}){const s=O,A=M,v=V(),E=V(!1),D=V([]),I=V(!1),d=pe({client_id:"",product_info:"",amount:0,order_type:"NEW",contract_no:"",remark:""}),n={client_id:[{required:!0,message:"请选择客户",trigger:"change"}],product_info:[{required:!0,message:"请输入购买内容",trigger:"blur"}],amount:[{required:!0,message:"请输入应收金额",trigger:"blur"}],order_type:[{required:!0,message:"请选择订单类型",trigger:"change"}]},b=[{label:"新购",value:"NEW"},{label:"续费",value:"RENEW"},{label:"增购",value:"UPSELL"},{label:"人工服务",value:"SERVICE"},{label:"项目实施",value:"IMPLEMENTATION"}];ae(()=>s.visible,h=>{h&&(s.operateType==="edit"&&s.rowData?(Object.assign(d,{client_id:s.rowData.client_id,product_info:s.rowData.product_info,amount:s.rowData.amount,order_type:s.rowData.order_type,contract_no:s.rowData.contract_no,remark:s.rowData.remark}),D.value=[{label:s.rowData.client_name,value:s.rowData.client_id}]):(Object.assign(d,{client_id:"",product_info:"",amount:0,order_type:"NEW",contract_no:"",remark:""}),D.value=[]))});async function y(h){if(h){I.value=!0;try{const{data:u}=await _t({name:h,current:1,size:20});if(u){const C=Array.isArray(u)?u:u.items||u.records||[];D.value=C.map(g=>({label:g.name,value:g.id}))}}finally{I.value=!1}}else D.value=[]}async function o(){await v.value?.validate(),E.value=!0;try{s.operateType==="add"?(await ot(d),P.success("创建成功")):s.operateType==="edit"&&s.rowData&&(await Ve(s.rowData.id,d),P.success("更新成功")),A("submitted"),A("update:visible",!1)}finally{E.value=!1}}return(h,u)=>{const C=me,g=ce,w=ne,S=Ue,R=Me,j=re,x=ye,m=oe,z=J,U=_e;return c(),L(U,{"model-value":h.visible,title:h.operateType==="add"?"新建订单":"编辑订单",width:"600px","onUpdate:modelValue":u[7]||(u[7]=k=>A("update:visible",k))},{footer:e(()=>[l("span",ft,[t(z,{onClick:u[6]||(u[6]=k=>A("update:visible",!1))},{default:e(()=>[...u[8]||(u[8]=[i("取消",-1)])]),_:1}),t(z,{type:"primary",loading:E.value,onClick:o},{default:e(()=>[...u[9]||(u[9]=[i("确定",-1)])]),_:1},8,["loading"])])]),default:e(()=>[t(m,{ref_key:"formRef",ref:v,model:d,rules:n,"label-width":"100px"},{default:e(()=>[t(w,{label:"客户",prop:"client_id"},{default:e(()=>[t(g,{modelValue:d.client_id,"onUpdate:modelValue":u[0]||(u[0]=k=>d.client_id=k),filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入客户名称搜索","remote-method":y,loading:I.value,style:{width:"100%"},disabled:h.operateType==="edit"},{default:e(()=>[(c(!0),$(Y,null,q(D.value,k=>(c(),L(C,{key:k.value,label:k.label,value:k.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1}),t(w,{label:"订单类型",prop:"order_type"},{default:e(()=>[t(R,{modelValue:d.order_type,"onUpdate:modelValue":u[1]||(u[1]=k=>d.order_type=k)},{default:e(()=>[(c(),$(Y,null,q(b,k=>t(S,{key:k.value,label:k.value},{default:e(()=>[i(p(k.label),1)]),_:2},1032,["label"])),64))]),_:1},8,["modelValue"])]),_:1}),t(w,{label:"购买内容",prop:"product_info"},{default:e(()=>[t(j,{modelValue:d.product_info,"onUpdate:modelValue":u[2]||(u[2]=k=>d.product_info=k),type:"textarea",rows:3,placeholder:"例如：TalkMyData 企业版永久授权 x1"},null,8,["modelValue"])]),_:1}),t(w,{label:"应收金额",prop:"amount"},{default:e(()=>[t(x,{modelValue:d.amount,"onUpdate:modelValue":u[3]||(u[3]=k=>d.amount=k),precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(w,{label:"关联合同号",prop:"contract_no"},{default:e(()=>[t(j,{modelValue:d.contract_no,"onUpdate:modelValue":u[4]||(u[4]=k=>d.contract_no=k),placeholder:"可选"},null,8,["modelValue"])]),_:1}),t(w,{label:"备注",prop:"remark"},{default:e(()=>[t(j,{modelValue:d.remark,"onUpdate:modelValue":u[5]||(u[5]=k=>d.remark=k),type:"textarea",placeholder:"可选"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["model-value","title"])}}}),bt={class:"flex flex-col gap-4"},yt={class:"bg-gray-50 p-4 rounded border border-gray-200"},gt={class:"flex justify-between items-center mb-2"},wt={class:"flex gap-8"},ht={class:"text-lg font-bold"},xt={class:"text-lg font-bold text-gray-500"},kt={class:"flex gap-2"},Dt={class:"w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2"},Vt={class:"text-right text-xs text-gray-400 mt-1"},Et={key:0,class:"font-bold text-green-600"},Ct={key:1,class:"font-bold text-red-600"},At={key:0,class:"text-xs text-gray-400 mt-1"},$t={key:1,class:"text-xs text-gray-400 mt-1"},Lt=G({__name:"PaymentTab",props:{orderId:{},orderAmount:{}},emits:["update:order"],setup(O,{emit:M}){const s=O,A=M,v=V(!1),E=V([]),D=V(!1),I=V(!1),d=V(1),n=V({amount:0,type:1,pay_method:"BANK",transaction_id:"",remark:""}),b=[{label:"对公转账",value:"BANK"},{label:"微信支付",value:"WECHAT"},{label:"支付宝",value:"ALIPAY"},{label:"现金",value:"CASH"}],y=[{label:"原路退回",value:"BANK"},{label:"微信退款",value:"WECHAT"},{label:"支付宝退款",value:"ALIPAY"},{label:"现金退款",value:"CASH"}],o=H(()=>E.value.filter(x=>x.type===1).reduce((x,m)=>x+Number(m.amount),0)),h=H(()=>E.value.filter(x=>x.type===2).reduce((x,m)=>x+Number(m.amount),0)),u=H(()=>o.value-h.value),C=H(()=>Math.max(0,s.orderAmount-u.value)),g=H(()=>{if(s.orderAmount<=0)return 100;const x=u.value/s.orderAmount*100;return Math.min(100,Math.max(0,x))});async function w(){v.value=!0;try{const{data:x}=await nt(s.orderId);x&&(E.value=x)}finally{v.value=!1}}function S(x){d.value=x,n.value={amount:x===1?C.value:0,type:x,pay_method:"BANK",transaction_id:"",remark:""},D.value=!0}async function R(){if(n.value.amount<=0){P.warning("金额必须大于0");return}if(n.value.type===2&&n.value.amount>u.value){P.warning("退款金额不能大于净实收金额");return}I.value=!0;try{const{data:x}=await rt(s.orderId,n.value);x&&(P.success(n.value.type===1?"收款登记成功":"退款登记成功"),D.value=!1,w(),A("update:order"))}finally{I.value=!1}}async function j(x){try{await fe.confirm("确定要删除这条记录吗？这将影响订单状态。","警告",{type:"warning"}),await st(s.orderId,x.id),P.success("删除成功"),w(),A("update:order")}catch{}}return ae(()=>s.orderId,()=>{s.orderId&&w()},{immediate:!0}),(x,m)=>{const z=J,U=xe,k=se,ie=he,Z=ye,K=ne,f=me,r=ce,W=re,X=oe,de=_e,ee=we;return c(),$("div",bt,[l("div",yt,[l("div",gt,[l("div",wt,[l("div",null,[m[8]||(m[8]=l("div",{class:"text-xs text-gray-500 mb-1"},"应收总额",-1)),l("div",ht,"¥"+p(Math.round(x.orderAmount).toLocaleString()),1)]),l("div",null,[m[9]||(m[9]=l("div",{class:"text-xs text-gray-500 mb-1"},"净实收 (Net Paid)",-1)),l("div",{class:le(["text-lg font-bold",u.value>=x.orderAmount?"text-green-600":"text-blue-600"])}," ¥"+p(Math.round(u.value).toLocaleString()),3)]),l("div",null,[m[10]||(m[10]=l("div",{class:"text-xs text-gray-500 mb-1"},"待收",-1)),l("div",xt,"¥"+p(Math.round(C.value).toLocaleString()),1)])]),l("div",kt,[t(z,{type:"primary",onClick:m[0]||(m[0]=_=>S(1)),disabled:C.value<=0},{default:e(()=>[...m[11]||(m[11]=[l("div",{class:"i-ep-plus mr-1"},null,-1),i(" 登记收款 ",-1)])]),_:1},8,["disabled"]),t(z,{type:"danger",plain:"",onClick:m[1]||(m[1]=_=>S(2)),disabled:u.value<=0},{default:e(()=>[...m[12]||(m[12]=[l("div",{class:"i-ep-minus mr-1"},null,-1),i(" 登记退款 ",-1)])]),_:1},8,["disabled"])])]),l("div",Dt,[l("div",{class:le(["bg-blue-600 h-2.5 rounded-full",{"bg-green-500":g.value>=100}]),style:Te({width:`${g.value}%`})},null,6)]),l("div",Vt,p(g.value.toFixed(0))+"% 已结清",1)]),ge((c(),L(ie,{data:E.value,border:"",size:"small"},{default:e(()=>[t(U,{label:"时间",width:"160"},{default:e(({row:_})=>[i(p(Oe(ke)(_.pay_time).format("YYYY-MM-DD HH:mm")),1)]),_:1}),t(U,{label:"类型",width:"80",align:"center"},{default:e(({row:_})=>[t(k,{type:_.type===1?"success":"danger",size:"small"},{default:e(()=>[i(p(_.type===1?"收款":"退款"),1)]),_:2},1032,["type"])]),_:1}),t(U,{label:"金额",width:"120"},{default:e(({row:_})=>[_.type===1?(c(),$("span",Et,"+¥"+p(Math.round(_.amount).toLocaleString()),1)):(c(),$("span",Ct,"-¥"+p(Math.round(_.amount).toLocaleString()),1))]),_:1}),t(U,{prop:"pay_method",label:"方式",width:"100"},{default:e(({row:_})=>[t(k,{size:"small",effect:"plain"},{default:e(()=>[i(p(b.find(Q=>Q.value===_.pay_method)?.label||_.pay_method),1)]),_:2},1024)]),_:1}),t(U,{prop:"transaction_id",label:"流水号","min-width":"150","show-overflow-tooltip":""}),t(U,{prop:"remark",label:"备注","min-width":"150","show-overflow-tooltip":""}),t(U,{label:"操作",width:"80",align:"center"},{default:e(({row:_})=>[t(z,{link:"",type:"danger",size:"small",onClick:Q=>j(_)},{default:e(()=>[...m[13]||(m[13]=[i("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ee,v.value]]),t(de,{modelValue:D.value,"onUpdate:modelValue":m[7]||(m[7]=_=>D.value=_),title:d.value===1?"登记收款":"登记退款",width:"500px","append-to-body":""},{footer:e(()=>[t(z,{onClick:m[6]||(m[6]=_=>D.value=!1)},{default:e(()=>[...m[14]||(m[14]=[i("取消",-1)])]),_:1}),t(z,{type:d.value===1?"primary":"danger",loading:I.value,onClick:R},{default:e(()=>[i(p(d.value===1?"确认登记":"确认退款"),1)]),_:1},8,["type","loading"])]),default:e(()=>[t(X,{model:n.value,"label-width":"100px"},{default:e(()=>[t(K,{label:d.value===1?"收款金额":"退款金额",required:""},{default:e(()=>[t(Z,{modelValue:n.value.amount,"onUpdate:modelValue":m[2]||(m[2]=_=>n.value.amount=_),min:.01,max:d.value===1?C.value:u.value,precision:2,style:{width:"100%"}},null,8,["modelValue","max"]),d.value===1?(c(),$("div",At,"本次最多可收: ¥"+p(C.value),1)):(c(),$("div",$t,"本次最多可退: ¥"+p(u.value),1))]),_:1},8,["label"]),t(K,{label:d.value===1?"支付方式":"退款方式",required:""},{default:e(()=>[t(r,{modelValue:n.value.pay_method,"onUpdate:modelValue":m[3]||(m[3]=_=>n.value.pay_method=_),style:{width:"100%"}},{default:e(()=>[(c(!0),$(Y,null,q(d.value===1?b:y,_=>(c(),L(f,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),t(K,{label:d.value===1?"交易流水号":"退款单号"},{default:e(()=>[t(W,{modelValue:n.value.transaction_id,"onUpdate:modelValue":m[4]||(m[4]=_=>n.value.transaction_id=_),placeholder:d.value===1?"请输入外部交易单号":"请输入退款单号"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),t(K,{label:"备注",required:d.value===2},{default:e(()=>[t(W,{modelValue:n.value.remark,"onUpdate:modelValue":m[5]||(m[5]=_=>n.value.remark=_),type:"textarea",rows:2,placeholder:d.value===1?"例如：首付款30%":"请输入退款原因"},null,8,["modelValue","placeholder"])]),_:1},8,["required"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),It={class:"flex flex-col gap-4"},Nt={class:"flex justify-between items-center bg-gray-50 p-4 rounded border border-gray-200"},St={key:0,class:"text-center py-8 text-gray-400"},Pt={key:1,class:"grid grid-cols-1 gap-2"},Mt={class:"flex items-center gap-3 overflow-hidden"},Ut={class:"flex flex-col min-w-0"},Tt=["title"],Ot={class:"text-xs text-gray-400 uppercase"},Rt={class:"flex items-center gap-2 flex-shrink-0"},zt=G({__name:"AttachmentTab",props:{orderId:{},initialAttachments:{}},emits:["update:order"],setup(O,{emit:M}){const s=O,A=M,v=V([]),E=V(!1);ae(()=>s.initialAttachments,y=>{if(y)try{v.value=JSON.parse(y)}catch{v.value=[]}else v.value=[]},{immediate:!0});async function D(y){const{file:o}=y;E.value=!0;try{const{data:h}=await it(o);h&&(v.value.push(h),await d(),P.success("上传成功"))}catch{P.error("上传失败")}finally{E.value=!1}}async function I(y){try{await fe.confirm("确定要删除这个附件吗？","提示",{type:"warning"}),v.value.splice(y,1),await d(),P.success("删除成功")}catch{}}async function d(){await Ve(s.orderId,{attachments:JSON.stringify(v.value)}),A("update:order")}function n(y){const o=document.createElement("a");o.href="/api/v1"+y.url,o.target="_blank",o.download=y.name,document.body.appendChild(o),o.click(),document.body.removeChild(o)}function b(y){return["jpg","jpeg","png","gif"].includes(y.toLowerCase())?"i-ep-picture":["pdf"].includes(y.toLowerCase())?"i-ep-document":["zip","rar","7z"].includes(y.toLowerCase())?"i-ep-box":"i-ep-paperclip"}return(y,o)=>{const h=J,u=Re;return c(),$("div",It,[l("div",Nt,[o[1]||(o[1]=l("div",{class:"text-sm text-gray-500"}," 支持上传合同扫描件、验收单、发票截图等文件。 ",-1)),t(u,{action:"","http-request":D,"show-file-list":!1,disabled:E.value,accept:".pdf,.jpg,.jpeg,.png,.zip,.rar,.doc,.docx"},{default:e(()=>[t(h,{type:"primary",loading:E.value},{default:e(()=>[...o[0]||(o[0]=[l("div",{class:"i-ep-upload mr-1"},null,-1),i(" 上传附件 ",-1)])]),_:1},8,["loading"])]),_:1},8,["disabled"])]),v.value.length===0?(c(),$("div",St," 暂无附件 ")):(c(),$("div",Pt,[(c(!0),$(Y,null,q(v.value,(C,g)=>(c(),$("div",{key:g,class:"flex items-center justify-between p-3 border rounded hover:bg-gray-50"},[l("div",Mt,[l("div",{class:le([b(C.type),"text-2xl text-primary"])},null,2),l("div",Ut,[l("span",{class:"font-medium truncate",title:C.name},p(C.name),9,Tt),l("span",Ot,p(C.type)+" FILE",1)])]),l("div",Rt,[t(h,{link:"",type:"primary",onClick:w=>n(C)},{default:e(()=>[...o[2]||(o[2]=[i("下载",-1)])]),_:2},1032,["onClick"]),t(h,{link:"",type:"danger",onClick:w=>I(g)},{default:e(()=>[...o[3]||(o[3]=[i("删除",-1)])]),_:2},1032,["onClick"])])]))),128))]))])}}}),Bt={key:0,class:"flex flex-col h-full"},jt={class:"flex justify-between items-center mb-4 p-4 bg-gray-50 rounded"},Wt={class:"flex gap-4 items-center"},Ht={class:"font-bold text-lg"},Yt={class:"text-gray-500"},qt={class:"font-bold text-black"},Kt={class:"flex flex-col gap-6"},Ft={class:"p-4 bg-gray-50 rounded border border-gray-200"},Gt={key:0,class:"mt-4"},Jt={key:0},Xt={class:"text-gray-600 bg-gray-50 p-2 rounded"},Qt=G({__name:"OrderDetailDrawer",props:{visible:{type:Boolean},rowData:{}},emits:["update:visible","submitted"],setup(O,{emit:M}){const s=O,A=M,v=ze(),E=V("info"),D=H(()=>s.rowData?.status==="PAID"&&["NEW","RENEW","UPSELL"].includes(s.rowData?.order_type||"")),I={PENDING:{label:"待支付",type:"warning"},PARTIAL:{label:"部分付款",type:"warning"},PAID:{label:"已支付",type:"success"},CANCELLED:{label:"已作废",type:"info"},REFUNDING:{label:"退款中",type:"danger"}};async function d(){s.rowData&&v.push({path:"/license/generate",query:{clientId:s.rowData.client_id,orderNo:s.rowData.order_no}})}return(n,b)=>{const y=se,o=He,h=We,u=J,C=je,g=Be,w=Ye;return c(),L(w,{"model-value":n.visible,title:"订单详情",size:"800px","onUpdate:modelValue":b[3]||(b[3]=S=>A("update:visible",S))},{default:e(()=>[n.rowData?(c(),$("div",Bt,[l("div",jt,[l("div",Wt,[l("span",Ht,p(n.rowData.order_no),1),t(y,{type:I[n.rowData.status]?.type||"info"},{default:e(()=>[i(p(I[n.rowData.status]?.label||n.rowData.status),1)]),_:1},8,["type"])]),l("div",Yt,[b[4]||(b[4]=i(" 总金额: ",-1)),l("span",qt,"¥"+p(Math.round(n.rowData.amount).toLocaleString()),1)])]),t(g,{modelValue:E.value,"onUpdate:modelValue":b[2]||(b[2]=S=>E.value=S),class:"flex-1 flex flex-col min-h-0"},{default:e(()=>[t(C,{label:"基础信息",name:"info",class:"overflow-auto h-full pr-2"},{default:e(()=>[l("div",Kt,[t(h,{title:"基础信息",column:2,border:""},{default:e(()=>[t(o,{label:"订单号"},{default:e(()=>[i(p(n.rowData.order_no),1)]),_:1}),t(o,{label:"状态"},{default:e(()=>[i(p(I[n.rowData.status]?.label||n.rowData.status),1)]),_:1}),t(o,{label:"应收金额"},{default:e(()=>[i("¥"+p(Math.round(n.rowData.amount).toLocaleString()),1)]),_:1}),t(o,{label:"实收金额"},{default:e(()=>[i("¥"+p(Math.round(n.rowData.actual_amount).toLocaleString()),1)]),_:1}),t(o,{label:"类型"},{default:e(()=>[i(p(n.rowData.order_type),1)]),_:1}),t(o,{label:"支付方式"},{default:e(()=>[i(p(n.rowData.pay_method),1)]),_:1}),t(o,{label:"创建时间"},{default:e(()=>[i(p(n.rowData.created_at),1)]),_:1}),t(o,{label:"合同号"},{default:e(()=>[i(p(n.rowData.contract_no||"-"),1)]),_:1})]),_:1}),t(h,{title:"客户信息",column:1,border:""},{default:e(()=>[t(o,{label:"客户名称"},{default:e(()=>[i(p(n.rowData.client_name),1)]),_:1})]),_:1}),l("div",null,[b[7]||(b[7]=l("h3",{class:"font-bold text-base mb-2"},"关联资产 (Licenses)",-1)),l("div",Ft,[b[6]||(b[6]=l("p",{class:"text-gray-500 text-sm mb-2"},"该订单包含的授权信息。",-1)),D.value?(c(),$("div",Gt,[t(u,{type:"warning",onClick:d},{default:e(()=>[...b[5]||(b[5]=[l("div",{class:"i-ep-lightning mr-1"},null,-1),i(" 为此订单生成授权 ",-1)])]),_:1})])):N("",!0)])]),n.rowData.remark?(c(),$("div",Jt,[b[8]||(b[8]=l("h3",{class:"font-bold text-base mb-2"},"备注",-1)),l("p",Xt,p(n.rowData.remark),1)])):N("",!0)])]),_:1}),t(C,{label:"资金/回款",name:"payment",class:"overflow-auto h-full pr-2"},{default:e(()=>[t(Lt,{"order-id":n.rowData.id,"order-amount":n.rowData.amount,"onUpdate:order":b[0]||(b[0]=S=>A("submitted"))},null,8,["order-id","order-amount"])]),_:1}),t(C,{label:"附件/合同",name:"attachment",class:"overflow-auto h-full pr-2"},{default:e(()=>[t(zt,{"order-id":n.rowData.id,"initial-attachments":n.rowData.attachments,"onUpdate:order":b[1]||(b[1]=S=>A("submitted"))},null,8,["order-id","initial-attachments"])]),_:1})]),_:1},8,["modelValue"])])):N("",!0)]),_:1},8,["model-value"])}}}),Zt=De(Qt,[["__scopeId","data-v-cf69b199"]]),el={class:"mb-4"},tl=G({__name:"PaymentConfirmDialog",props:{visible:{type:Boolean},rowData:{}},emits:["update:visible","success"],setup(O,{emit:M}){const s=O,A=M,v=V(),E=V(!1),D=pe({external_transaction_no:""}),I={external_transaction_no:[{required:!0,message:"请输入交易流水号",trigger:"blur"}]},d=H(()=>{if(!s.rowData)return{label:"外部流水号",placeholder:"请输入外部流水号"};switch(s.rowData.pay_method){case"WECHAT":return{label:"微信支付单号",placeholder:"请输入微信支付凭证号 (42000...)"};case"ALIPAY":return{label:"支付宝交易号",placeholder:"请输入 28 位交易号"};case"BANK":return{label:"打款户名/回单号",placeholder:"请输入对方汇款账户名，以便财务查账"};default:return{label:"外部流水号",placeholder:"请输入外部流水号"}}}),n=H(()=>s.rowData?{WECHAT:"微信支付",ALIPAY:"支付宝",BANK:"对公转账",CASH:"现金"}[s.rowData.pay_method]||s.rowData.pay_method:"");ae(()=>s.visible,y=>{y&&s.rowData?D.external_transaction_no=s.rowData.external_transaction_no||"":D.external_transaction_no=""});async function b(){if(await v.value?.validate(),!!s.rowData){E.value=!0;try{await dt(s.rowData.id,"PAID",D.external_transaction_no),P.success("确认收款成功"),A("success"),A("update:visible",!1)}finally{E.value=!1}}}return(y,o)=>{const h=se,u=re,C=ne,g=oe,w=J,S=_e;return c(),L(S,{"model-value":y.visible,title:"确认收款",width:"500px","onUpdate:modelValue":o[2]||(o[2]=R=>A("update:visible",R))},{footer:e(()=>[t(w,{onClick:o[1]||(o[1]=R=>A("update:visible",!1))},{default:e(()=>[...o[5]||(o[5]=[i("取消",-1)])]),_:1}),t(w,{type:"primary",loading:E.value,onClick:b},{default:e(()=>[...o[6]||(o[6]=[i("确认收款",-1)])]),_:1},8,["loading"])]),default:e(()=>[l("div",el,[l("p",null,[o[3]||(o[3]=i("当前支付方式： ",-1)),t(h,null,{default:e(()=>[i(p(n.value),1)]),_:1})]),o[4]||(o[4]=l("p",{class:"text-gray-500 text-sm mt-1"},"请核对支付方式并录入对应的交易流水号。",-1))]),t(g,{ref_key:"formRef",ref:v,model:D,rules:I,"label-width":"120px"},{default:e(()=>[t(C,{label:d.value.label,prop:"external_transaction_no"},{default:e(()=>[t(u,{modelValue:D.external_transaction_no,"onUpdate:modelValue":o[0]||(o[0]=R=>D.external_transaction_no=R),placeholder:d.value.placeholder},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["model-value"])}}}),ll={class:"h-full overflow-hidden flex flex-col p-4 gap-4"},al={class:"text-2xl font-bold"},ol={class:"text-2xl font-bold text-orange-500"},nl={class:"text-2xl font-bold"},rl={class:"mb-4 flex justify-between items-center"},sl={class:"flex items-center justify-center gap-2"},il=["onClick"],dl={key:0,class:"text-xs text-gray-400"},ul={class:"font-bold"},pl={class:"flex items-center justify-center"},cl={class:"el-dropdown-link flex items-center"},ml={class:"mt-4 flex justify-end"},_l=G({name:"order_list",__name:"index",setup(O){const M=V(!1),s=V([]),A=V({monthly_revenue:0,pending_amount:0,monthly_count:0}),v=V({status:void 0,client_name:"",order_no:"",pay_method:void 0}),E=V(!1),D=V(!1),I=V(!1),d=V("add"),n=V(null),b=V([{label:"订单号",prop:"order_no",visible:!0,minWidth:"180",align:"center"},{label:"客户名称",prop:"client_name",visible:!0,minWidth:"150",showOverflowTooltip:!0},{label:"客户类型",prop:"client_type",visible:!0,width:"100",align:"center"},{label:"购买内容",prop:"product_info",visible:!0,minWidth:"200",showOverflowTooltip:!0,align:"left",headerAlign:"left",className:"col-custom-left"},{label:"金额",prop:"amount",visible:!0,width:"120",align:"right",headerAlign:"right",className:"col-custom-right"},{label:"类型",prop:"order_type",visible:!0,width:"100"},{label:"状态",prop:"status",visible:!0,width:"100"},{label:"支付方式",prop:"pay_method",visible:!0,width:"100",align:"center"},{label:"创建时间",prop:"created_at",visible:!0,width:"160"}]),y=V(b.value.map(f=>f.prop));function o(f){return y.value.includes(f)}const h={PENDING:{label:"待支付",type:"warning"},PARTIAL:{label:"部分付款",type:"warning"},PAID:{label:"已支付",type:"success"},REFUND_PART:{label:"部分退款",type:"danger"},REFUNDED:{label:"已全退",type:"danger"},VOID:{label:"已作废",type:"info"}},u={NEW:"新购",RENEW:"续费",UPSELL:"增购",SERVICE:"人工服务",IMPLEMENTATION:"项目实施"},C={WECHAT:"微信",ALIPAY:"支付宝",BANK:"银行转账",CASH:"现金"},g=pe({currentPage:1,pageSize:20,total:0});async function w(){M.value=!0;try{const{data:f}=await ut({...v.value,skip:(g.currentPage-1)*g.pageSize,limit:g.pageSize});f&&(Array.isArray(f)?(s.value=f,g.total=f.length):f.items?(s.value=f.items,g.total=f.total||f.items.length):s.value=f);const r=await pt();r.data&&(A.value=r.data)}finally{M.value=!1}}function S(f){g.pageSize=f,w()}function R(f){g.currentPage=f,w()}function j(){g.currentPage=1,w()}function x(){v.value={status:void 0,client_name:"",order_no:"",pay_method:void 0},g.currentPage=1,w()}function m(){d.value="add",n.value=null,E.value=!0}function z(f){d.value="edit",n.value=f,E.value=!0}function U(f){n.value=f,D.value=!0}async function k(f){if(!f.is_invoiced)try{await ct(f.id,!0),P.success("已标记为已开票"),w()}catch{}}async function ie(f){if(f.total_paid>0){P.warning("该订单已产生资金流水，请先将款项全部退回/删除收款记录后，再进行作废操作。");return}try{await fe.confirm("确定要作废此订单吗？作废后不可恢复。","警告",{type:"warning",confirmButtonText:"确认作废",cancelButtonText:"取消"}),await mt(f.id),P.success("订单已作废"),w()}catch{}}function Z(f){navigator.clipboard.writeText(f.order_no),P.success("订单号已复制")}function K(f){return f?ke(f).format("YYYY-MM-DD HH:mm"):"-"}return qe(()=>{w()}),(f,r)=>{const W=Fe,X=Ke,de=Ge,ee=re,_=ne,Q=me,ve=ce,F=J,Ee=oe,Ce=Qe,Ae=Xe,$e=Je,B=xe,ue=se,te=lt,Le=tt,Ie=et,Ne=he,Se=at,Pe=we;return c(),$("div",ll,[t(de,{gutter:20},{default:e(()=>[t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...r[10]||(r[10]=[l("div",{class:"card-header"},[l("span",null,"本月成交额")],-1)])]),default:e(()=>[l("div",al,"¥ "+p(Math.round(A.value.monthly_revenue).toLocaleString()),1)]),_:1})]),_:1}),t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...r[11]||(r[11]=[l("div",{class:"card-header"},[l("span",null,"待回款金额")],-1)])]),default:e(()=>[l("div",ol,"¥ "+p(Math.round(A.value.pending_amount).toLocaleString()),1)]),_:1})]),_:1}),t(X,{span:8},{default:e(()=>[t(W,{shadow:"never"},{header:e(()=>[...r[12]||(r[12]=[l("div",{class:"card-header"},[l("span",null,"本月订单数")],-1)])]),default:e(()=>[l("div",nl,p(A.value.monthly_count),1)]),_:1})]),_:1})]),_:1}),t(W,{shadow:"never",class:"flex-none"},{default:e(()=>[t(Ee,{inline:!0,model:v.value},{default:e(()=>[t(_,{label:"订单号"},{default:e(()=>[t(ee,{modelValue:v.value.order_no,"onUpdate:modelValue":r[0]||(r[0]=a=>v.value.order_no=a),placeholder:"输入订单号",clearable:"",onKeyup:be(j,["enter"])},null,8,["modelValue"])]),_:1}),t(_,{label:"客户名称"},{default:e(()=>[t(ee,{modelValue:v.value.client_name,"onUpdate:modelValue":r[1]||(r[1]=a=>v.value.client_name=a),placeholder:"输入客户名称",clearable:"",onKeyup:be(j,["enter"])},null,8,["modelValue"])]),_:1}),t(_,{label:"支付方式"},{default:e(()=>[t(ve,{modelValue:v.value.pay_method,"onUpdate:modelValue":r[2]||(r[2]=a=>v.value.pay_method=a),placeholder:"选择支付方式",clearable:"",style:{width:"150px"}},{default:e(()=>[(c(),$(Y,null,q(C,(a,T)=>t(Q,{key:T,label:a,value:T},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"状态"},{default:e(()=>[t(ve,{modelValue:v.value.status,"onUpdate:modelValue":r[3]||(r[3]=a=>v.value.status=a),placeholder:"选择状态",clearable:"",style:{width:"150px"}},{default:e(()=>[(c(),$(Y,null,q(h,(a,T)=>t(Q,{key:T,label:a.label,value:T},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(_,null,{default:e(()=>[t(F,{type:"primary",onClick:j},{default:e(()=>[...r[13]||(r[13]=[i("搜索",-1)])]),_:1}),t(F,{onClick:x},{default:e(()=>[...r[14]||(r[14]=[i("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(W,{shadow:"never",class:"flex-1 flex flex-col min-h-0"},{default:e(()=>[l("div",rl,[t(F,{type:"primary",onClick:m},{default:e(()=>[...r[15]||(r[15]=[i("新建订单",-1)])]),_:1}),t($e,{placement:"bottom",title:"列设置",trigger:"click",width:200},{reference:e(()=>[t(F,null,{default:e(()=>[...r[16]||(r[16]=[l("div",{class:"i-ep-setting text-lg"},null,-1)])]),_:1})]),default:e(()=>[t(Ae,{modelValue:y.value,"onUpdate:modelValue":r[4]||(r[4]=a=>y.value=a),min:1,class:"flex flex-col gap-2"},{default:e(()=>[(c(!0),$(Y,null,q(b.value,a=>(c(),L(Ce,{key:a.prop,label:a.prop,value:a.prop},{default:e(()=>[i(p(a.label),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),ge((c(),L(Ne,{data:s.value,border:"",style:{width:"100%",height:"100%"}},{default:e(()=>[o("order_no")?(c(),L(B,{key:0,prop:"order_no",label:"订单号","min-width":"180",align:"center"},{default:e(({row:a})=>[l("div",sl,[l("span",{class:le(["font-mono font-bold",{"line-through text-gray-400":a.status==="VOID"}])},p(a.order_no),3),l("div",{class:"i-ep-document-copy cursor-pointer text-gray-400 hover:text-primary",onClick:Ze(T=>Z(a),["stop"])},null,8,il)]),a.contract_no?(c(),$("div",dl,"合同: "+p(a.contract_no),1)):N("",!0)]),_:1})):N("",!0),o("client_name")?(c(),L(B,{key:1,prop:"client_name",label:"客户名称","min-width":"150","show-overflow-tooltip":""})):N("",!0),o("client_type")?(c(),L(B,{key:2,prop:"client_type",label:"客户类型",width:"100",align:"center"},{default:e(({row:a})=>[t(ue,{type:a.client_type===1?"warning":"success",size:"small"},{default:e(()=>[i(p(a.client_type===1?"企业":"个人"),1)]),_:2},1032,["type"])]),_:1})):N("",!0),o("product_info")?(c(),L(B,{key:3,prop:"product_info",label:"购买内容","min-width":"200","show-overflow-tooltip":"",align:"left","header-align":"left","class-name":"col-custom-left"})):N("",!0),o("amount")?(c(),L(B,{key:4,prop:"amount",label:"金额",width:"120",align:"right","header-align":"right","class-name":"col-custom-right"},{default:e(({row:a})=>[l("span",ul,"¥"+p(Math.round(a.amount).toLocaleString()),1)]),_:1})):N("",!0),o("order_type")?(c(),L(B,{key:5,prop:"order_type",label:"类型",width:"100"},{default:e(({row:a})=>[t(ue,null,{default:e(()=>[i(p(u[a.order_type]||a.order_type),1)]),_:2},1024)]),_:1})):N("",!0),o("status")?(c(),L(B,{key:6,prop:"status",label:"状态",width:"100"},{default:e(({row:a})=>[t(ue,{type:h[a.status]?.type||"info"},{default:e(()=>[i(p(h[a.status]?.label||a.status),1)]),_:2},1032,["type"])]),_:1})):N("",!0),o("pay_method")?(c(),L(B,{key:7,prop:"pay_method",label:"支付方式",width:"100",align:"center"},{default:e(({row:a})=>[i(p(C[a.pay_method]||a.pay_method),1)]),_:1})):N("",!0),o("created_at")?(c(),L(B,{key:8,prop:"created_at",label:"创建时间",width:"160"},{default:e(({row:a})=>[i(p(K(a.created_at)),1)]),_:1})):N("",!0),t(B,{label:"操作",width:"150",fixed:"right",align:"center"},{default:e(({row:a})=>[l("div",pl,[t(F,{link:"",type:"primary",onClick:T=>U(a)},{default:e(()=>[...r[17]||(r[17]=[i("详情",-1)])]),_:2},1032,["onClick"]),a.status!=="VOID"?(c(),L(Ie,{key:0,trigger:"click",class:"ml-2 flex items-center"},{dropdown:e(()=>[t(Le,null,{default:e(()=>[t(te,{onClick:T=>z(a)},{default:e(()=>[...r[19]||(r[19]=[i("编辑",-1)])]),_:2},1032,["onClick"]),a.is_invoiced?N("",!0):(c(),L(te,{key:0,onClick:T=>k(a)},{default:e(()=>[...r[20]||(r[20]=[i("标记已开票",-1)])]),_:2},1032,["onClick"])),t(te,{onClick:T=>Z(a)},{default:e(()=>[...r[21]||(r[21]=[i("复制单号",-1)])]),_:2},1032,["onClick"]),t(te,{divided:"",class:"text-red-500",onClick:T=>ie(a)},{default:e(()=>[...r[22]||(r[22]=[i("作废订单",-1)])]),_:2},1032,["onClick"])]),_:2},1024)]),default:e(()=>[l("span",cl,[t(F,{link:"",type:"primary"},{default:e(()=>[...r[18]||(r[18]=[i("操作",-1)])]),_:1})])]),_:2},1024)):N("",!0)])]),_:1})]),_:1},8,["data"])),[[Pe,M.value]]),l("div",ml,[t(Se,{"current-page":g.currentPage,"onUpdate:currentPage":r[5]||(r[5]=a=>g.currentPage=a),"page-size":g.pageSize,"onUpdate:pageSize":r[6]||(r[6]=a=>g.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:g.total,onSizeChange:S,onCurrentChange:R},null,8,["current-page","page-size","total"])])]),_:1}),t(vt,{visible:E.value,"onUpdate:visible":r[7]||(r[7]=a=>E.value=a),"operate-type":d.value,"row-data":n.value,onSubmitted:w},null,8,["visible","operate-type","row-data"]),t(Zt,{visible:D.value,"onUpdate:visible":r[8]||(r[8]=a=>D.value=a),"row-data":n.value,onSubmitted:w},null,8,["visible","row-data"]),t(tl,{visible:I.value,"onUpdate:visible":r[9]||(r[9]=a=>I.value=a),"row-data":n.value,onSuccess:w},null,8,["visible","row-data"])])}}}),yl=De(_l,[["__scopeId","data-v-478cf2c4"]]);export{yl as default};
