import{d as me,M as R,r as _,N as pe,b as k,o as y,f as t,w as a,e as c,q as fe,x as _e,E as ye,g as r,J as ve,O as F,c as M,P as ge,Q as be,ai as P,aj as K,R as we,t as m,U as he,am as xe,G as ke,ab as Ce,ac as Ee,an as Ve,ao as Le,ap as Se,y as De,p as je,W as Ue,X as ze,a1 as Re,a2 as v,a4 as Me}from"./index-Cl2Qds7-.js";import{f as Pe,d as I,a as Oe}from"./license-record-ClMi1t9q.js";import{f as Te}from"./license-config-B1dkp8ko.js";import{f as Be,s as Ne}from"./email-DL8qRGB7.js";const $e={class:"h-full overflow-hidden flex flex-col p-4 gap-4"},Ae={class:"flex gap-4"},Fe={class:"flex items-center"},Ke={class:"grid grid-cols-2 gap-2 px-4 py-1"},Ie={class:"mt-4 flex justify-end"},Ge={class:"h-full flex flex-col"},Je={class:"flex-1 overflow-hidden flex flex-col"},qe={class:"flex-1 bg-white rounded border border-gray-200 overflow-auto"},He={class:"mt-4"},Qe={class:"text-xs font-mono bg-gray-50 p-2 overflow-auto max-h-40"},We={class:"mt-6 flex justify-end"},Xe={class:"dialog-footer"},J=me({name:"commercial_history",__name:"index",setup(et){const C=R({keyword:""}),j=_(!1),E=_([]),u=R({currentPage:1,pageSize:20,total:0}),O=_({});async function q(){try{const{data:o}=await Te({is_active:void 0});if(o){const e=Array.isArray(o)?o:o.items||[],n={};e.forEach(s=>{s.module_name_cn&&(n[s.module_code]=s.module_name_cn,n[s.module_name]=s.module_name_cn)}),O.value=n}}catch(o){console.error("Failed to fetch module configs",o)}}function T(o){return O.value[o]||o}async function b(){j.value=!0;try{const{data:o}=await Pe({...C,skip:(u.currentPage-1)*u.pageSize,limit:u.pageSize});o&&(Array.isArray(o)?(E.value=o,u.total=o.length):o.items?(E.value=o.items,u.total=o.total||o.items.length):E.value=o)}finally{j.value=!1}}function H(o){u.pageSize=o,b()}function Q(o){u.currentPage=o,b()}function B(){u.currentPage=1,b()}function W(){C.keyword="",u.currentPage=1,b()}async function X(o){try{const e=await I(o.id),n=new Blob([e.data],{type:"application/octet-stream"}),s=window.URL.createObjectURL(n),f=document.createElement("a");f.href=s;const p=`${o.license_key}.key`;f.setAttribute("download",p),document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(s)}catch{v.error("下载失败")}}const w=_(!1),d=_(null),U=_(!1);async function Y(o){w.value=!0,U.value=!0,d.value=null;try{const{data:e}=await Oe(o.id);e&&(d.value=e)}catch{v.error("获取详情失败"),w.value=!1}finally{U.value=!1}}async function Z(){if(d.value)try{const o=await I(d.value.id),e=new Blob([o.data],{type:"application/octet-stream"}),n=window.URL.createObjectURL(e),s=document.createElement("a");s.href=n;const f=`${d.value.license_key}.key`;s.setAttribute("download",f),document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(n)}catch{v.error("下载失败")}}const h=_(!1),z=_(!1),i=R({to_email:"",subject:"",content:"",template_id:null}),V=_([]),L=_(null);async function ee(o){if(L.value=o,h.value=!0,i.to_email="",i.subject="",i.content="",i.template_id=null,V.value.length===0)try{const{data:e}=await Be();e&&(V.value=e)}catch{v.error("获取模板失败")}}function N(o,e){let n=o;if(!n)return"";n=n.replace(/{{client_name}}/g,e.customer_name||""),n=n.replace(/{{license_key}}/g,e.license_key||""),n=n.replace(/{{product_name}}/g,"TalkMyData");const s=e.expire_at_min||e.expire_time||"";return n=n.replace(/{{expire_date}}/g,String(s)),n}function te(o){const e=V.value.find(n=>n.id===o);e&&L.value&&(i.subject=N(e.subject,L.value),i.content=N(e.content,L.value))}async function le(){if(!i.to_email){v.warning("请输入收件人邮箱");return}if(!i.subject||!i.content){v.warning("请完善邮件内容");return}z.value=!0;try{await Ne({to_email:i.to_email,subject:i.subject,content:i.content}),v.success("发送成功"),h.value=!1}catch(o){v.error(o.message||"发送失败")}finally{z.value=!1}}return pe(()=>{q(),b()}),(o,e)=>{const n=fe,s=ye,f=ve,p=be,S=we,$=ge,ae=xe,g=Ee,oe=Ce,ne=Le,se=Ve,ie=Se,re=ze,de=Ue,D=je,ue=De,ce=Re,A=he;return y(),k("div",$e,[t(f,{shadow:"never",class:"flex-none"},{default:a(()=>[c("div",Ae,[c("div",Fe,[e[11]||(e[11]=c("span",{class:"mr-2 text-sm text-gray-600"},"关键词",-1)),t(n,{modelValue:C.keyword,"onUpdate:modelValue":e[0]||(e[0]=l=>C.keyword=l),placeholder:"请输入客户名称或 License Key",class:"w-64",clearable:"",onKeyup:_e(B,["enter"])},null,8,["modelValue"])]),c("div",null,[t(s,{type:"primary",onClick:B},{default:a(()=>[...e[12]||(e[12]=[r("搜索",-1)])]),_:1}),t(s,{onClick:W},{default:a(()=>[...e[13]||(e[13]=[r("重置",-1)])]),_:1})])])]),_:1}),t(f,{shadow:"never",class:"flex-1 flex flex-col min-h-0","body-style":{display:"flex",flexDirection:"column",height:"100%"}},{default:a(()=>[F((y(),M($,{data:E.value,border:"",style:{width:"100%",height:"100%"},class:"flex-1"},{default:a(()=>[t(p,{prop:"license_key",label:"授权编号 (Key)","min-width":"200","show-overflow-tooltip":""}),t(p,{prop:"customer_name",label:"客户名称","min-width":"150","show-overflow-tooltip":""}),t(p,{label:"包含模块",width:"350","show-overflow-tooltip":""},{default:a(({row:l})=>[c("div",Ke,[(y(!0),k(P,null,K(l.summary_modules.split(", ").filter(Boolean),x=>(y(),M(S,{key:x,size:"small",type:"info",effect:"plain",class:"w-full justify-center"},{default:a(()=>[r(m(T(x)),1)]),_:2},1024))),128))])]),_:1}),t(p,{prop:"expire_at_min",label:"到期日期","min-width":"120",sortable:""},{default:a(({row:l})=>[r(m(l.expire_at_min),1)]),_:1}),t(p,{prop:"created_at",label:"生成时间",width:"180"},{default:a(({row:l})=>[r(m(new Date(l.created_at).toLocaleString()),1)]),_:1}),t(p,{label:"状态",width:"100",align:"center"},{default:a(({row:l})=>[t(S,{type:l.is_expired?"danger":"success"},{default:a(()=>[r(m(l.is_expired?"已过期":"生效中"),1)]),_:2},1032,["type"])]),_:1}),t(p,{label:"操作",width:"200",fixed:"right",align:"center"},{default:a(({row:l})=>[t(s,{link:"",type:"primary",onClick:x=>X(l)},{default:a(()=>[...e[14]||(e[14]=[r("下载",-1)])]),_:2},1032,["onClick"]),t(s,{link:"",type:"primary",onClick:x=>ee(l)},{default:a(()=>[...e[15]||(e[15]=[r("发送邮件",-1)])]),_:2},1032,["onClick"]),t(s,{link:"",type:"primary",onClick:x=>Y(l)},{default:a(()=>[...e[16]||(e[16]=[r("详情",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[A,j.value]]),c("div",Ie,[t(ae,{"current-page":u.currentPage,"onUpdate:currentPage":e[1]||(e[1]=l=>u.currentPage=l),"page-size":u.pageSize,"onUpdate:pageSize":e[2]||(e[2]=l=>u.pageSize=l),total:u.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:H,onCurrentChange:Q},null,8,["current-page","page-size","total"])])]),_:1}),t(ie,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=l=>w.value=l),title:"授权详情",size:"650px"},{default:a(()=>[F((y(),k("div",Ge,[d.value?(y(),k(P,{key:0},[t(oe,{column:1,border:"",class:"mb-6"},{default:a(()=>[t(g,{label:"License Key"},{default:a(()=>[r(m(d.value.license_key),1)]),_:1}),t(g,{label:"客户名称"},{default:a(()=>[r(m(d.value.customer_name),1)]),_:1}),t(g,{label:"绑定机器"},{default:a(()=>[r(m(d.value.hardware_id||"-"),1)]),_:1}),t(g,{label:"到期日期"},{default:a(()=>[r(m(d.value.content_snapshot?.expire_at||"-"),1)]),_:1}),t(g,{label:"生成时间"},{default:a(()=>[r(m(new Date(d.value.created_at).toLocaleString()),1)]),_:1}),t(g,{label:"状态"},{default:a(()=>[t(S,{type:d.value.is_expired?"danger":"success"},{default:a(()=>[r(m(d.value.is_expired?"已过期":"生效中"),1)]),_:1},8,["type"])]),_:1})]),_:1}),c("div",Je,[e[17]||(e[17]=c("div",{class:"text-sm font-bold mb-2 text-gray-700"},"授权模块列表",-1)),c("div",qe,[t($,{data:d.value.content_snapshot?.modules||[],size:"small",border:"",stripe:""},{default:a(()=>[t(p,{label:"模块名称","min-width":"120"},{default:a(({row:l})=>[r(m(l.name_cn||T(l.name)||l.name),1)]),_:1}),t(p,{prop:"expire_at",label:"过期时间",width:"120"}),t(p,{prop:"type",label:"类型",width:"80"},{default:a(({row:l})=>[t(S,{size:"small",type:l.type==="SYSTEM"?"danger":"primary"},{default:a(()=>[r(m(l.type),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),c("div",He,[t(se,null,{default:a(()=>[t(ne,{title:"原始数据快照 (JSON)",name:"1"},{default:a(()=>[c("pre",Qe,m(JSON.stringify(d.value.content_snapshot,null,2)),1)]),_:1})]),_:1})])]),c("div",We,[t(s,{onClick:e[3]||(e[3]=l=>w.value=!1)},{default:a(()=>[...e[18]||(e[18]=[r("关闭",-1)])]),_:1}),t(s,{type:"primary",onClick:Z},{default:a(()=>[...e[19]||(e[19]=[r("下载文件",-1)])]),_:1})])],64)):ke("",!0)])),[[A,U.value]])]),_:1},8,["modelValue"]),t(ce,{modelValue:h.value,"onUpdate:modelValue":e[10]||(e[10]=l=>h.value=l),title:"发送邮件",width:"600px"},{footer:a(()=>[c("div",Xe,[t(s,{onClick:e[9]||(e[9]=l=>h.value=!1)},{default:a(()=>[...e[20]||(e[20]=[r("取消",-1)])]),_:1}),t(s,{type:"primary",loading:z.value,onClick:le},{default:a(()=>[...e[21]||(e[21]=[r("发送",-1)])]),_:1},8,["loading"])])]),default:a(()=>[t(ue,{model:i,"label-width":"80px"},{default:a(()=>[t(D,{label:"选择模板"},{default:a(()=>[t(de,{modelValue:i.template_id,"onUpdate:modelValue":e[5]||(e[5]=l=>i.template_id=l),placeholder:"请选择模板",class:"w-full",onChange:te},{default:a(()=>[(y(!0),k(P,null,K(V.value,l=>(y(),M(re,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(D,{label:"收件邮箱"},{default:a(()=>[t(n,{modelValue:i.to_email,"onUpdate:modelValue":e[6]||(e[6]=l=>i.to_email=l),placeholder:"请输入收件人邮箱"},null,8,["modelValue"])]),_:1}),t(D,{label:"邮件标题"},{default:a(()=>[t(n,{modelValue:i.subject,"onUpdate:modelValue":e[7]||(e[7]=l=>i.subject=l),placeholder:"邮件标题"},null,8,["modelValue"])]),_:1}),t(D,{label:"邮件正文"},{default:a(()=>[t(n,{modelValue:i.content,"onUpdate:modelValue":e[8]||(e[8]=l=>i.content=l),type:"textarea",rows:10,placeholder:"邮件正文 (支持HTML)"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ye="commercial_history",Ze={title:"commercial_history",i18nKey:"route.commercial_history",order:1},G={name:Ye,meta:Ze};typeof G=="function"&&G(J);const nt=Me(J,[["__scopeId","data-v-5e52db91"]]);export{nt as default};
